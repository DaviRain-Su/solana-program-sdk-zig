# Story: v0.8.0 Native Programs

> Native program interfaces for CPI (Cross-Program Invocation) and transaction building

## 目标

Implement interfaces to interact with Solana's native programs from on-chain programs and off-chain transaction builders.

## 验收标准

### system_program.zig

- [x] Program ID constant (11111111111111111111111111111111)
- [x] SystemInstruction enum (CreateAccount, Transfer, Allocate, Assign, etc.)
- [x] BuiltInstruction type for off-chain use
- [x] createAccount() instruction builder
- [x] transfer() instruction builder
- [x] assign() instruction builder
- [x] allocate() instruction builder
- [x] MAX_PERMITTED_DATA_LENGTH constant
- [x] Rust source reference at file top
- [x] Unit tests (5 tests)

### bpf_loader.zig

- [x] BPF Loader v1 (deprecated) program ID
- [x] BPF Loader v2 program ID
- [x] BPF Loader Upgradeable program ID
- [x] isBpfLoader() helper function
- [x] isUpgradeableLoader() helper function
- [x] UpgradeableLoaderState union type
- [x] State size constants
- [x] getProgramDataAddress() PDA derivation
- [x] Rust source reference at file top
- [x] Unit tests (5 tests)

### ed25519_program.zig

- [x] Program ID constant (Ed25519SigVerify111111111111111111111111111)
- [x] Ed25519SignatureOffsets struct
- [x] Constants (PUBKEY_SIZE, SIGNATURE_SIZE, DATA_START, etc.)
- [x] forCurrentInstruction() helper
- [x] toBytes() serialization
- [x] createInstruction() builder
- [x] Rust source reference at file top
- [x] Unit tests (5 tests)

### secp256k1_program.zig

- [x] Program ID constant (KeccakSecp256k11111111111111111111111111111)
- [x] SecpSignatureOffsets struct
- [x] Constants (ETH_ADDRESS_SIZE, SIGNATURE_SIZE, etc.)
- [x] Recovery ID handling
- [x] forCurrentInstruction() helper
- [x] toBytes() serialization
- [x] createInstruction() builder
- [x] Rust source reference at file top
- [x] Unit tests (5 tests)

### Integration

- [x] root.zig exports
- [x] 测试通过 (20 new tests, all passing)
- [x] ROADMAP.md 更新

## 完成状态

- 开始日期: 2026-01-03
- 完成日期: 2026-01-03
- 当前状态: ✅ 已完成

## Rust 源码参考

| Zig 模块 | Rust crate |
|----------|-----------|
| system_program.zig | [system-interface](https://github.com/anza-xyz/solana-sdk/tree/master/system-interface) |
| bpf_loader.zig | [sdk-ids](https://github.com/anza-xyz/solana-sdk/tree/master/sdk-ids) |
| ed25519_program.zig | [ed25519-program](https://github.com/anza-xyz/solana-sdk/tree/master/ed25519-program) |
| secp256k1_program.zig | [secp256k1-program](https://github.com/anza-xyz/solana-sdk/tree/master/secp256k1-program) |

## 实现说明

### system_program.zig
- 实现了主要的系统指令构建器 (CreateAccount, Transfer, Assign, Allocate)
- 使用 BuiltInstruction 类型用于链下交易构建
- 完整的 SystemInstruction 枚举定义

### bpf_loader.zig
- 提供所有三个 BPF loader 的程序 ID
- 包含 UpgradeableLoaderState 类型定义
- 辅助函数用于识别 loader 类型

### ed25519_program.zig
- Ed25519 签名验证程序接口
- 支持嵌入式签名和跨指令引用
- 14 字节的偏移结构序列化

### secp256k1_program.zig
- Secp256k1/以太坊兼容签名验证
- 包含 recovery ID 处理
- 11 字节的偏移结构序列化

## 注意事项

- stake_program 未实现 - 功能复杂，延迟到后续版本
- 这些模块主要用于链下交易构建
- CPI 使用需要配合 instruction.zig 中的 Instruction 类型
