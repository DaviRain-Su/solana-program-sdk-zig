# Story: v0.7.0 Extended Sysvars

> Extended system variable access for Solana programs

## 目标

Implement additional sysvar modules for epoch scheduling and slot history tracking.

## 验收标准

### epoch_schedule.zig

- [x] EpochSchedule struct with all fields
- [x] Constants (MINIMUM_SLOTS_PER_EPOCH, DEFAULT_SLOTS_PER_EPOCH)
- [x] getEpoch(), getEpochAndSlotIndex() methods
- [x] getFirstSlotInEpoch(), getLastSlotInEpoch() methods
- [x] getSlotsInEpoch() method
- [x] Sysvar ID constant
- [x] get() syscall method
- [x] Warmup period support
- [x] Rust source reference at file top
- [x] Unit tests (8 tests)

### slot_history.zig

- [x] SlotHistory struct with bitvector
- [x] MAX_ENTRIES constant (1024 * 1024)
- [x] add() method to track slots
- [x] check() method returning Check enum
- [x] oldest(), newest() methods
- [x] contains() convenience method
- [x] Sysvar ID constant
- [x] Check enum (future, too_old, found, not_found)
- [x] Rust source reference at file top
- [x] Unit tests (8 tests)

### epoch_info.zig (MOVED)

- [x] ~~EpochInfo struct~~ → Implemented in `sdk/src/epoch_info.zig` (v0.29.0)
- **Note**: Not a sysvar - this is RPC response data, moved to SDK layer for Client SDK use

### stake_history.zig (IMPLEMENTED)

- [x] ~~StakeHistory struct~~ → Implemented in `sdk/src/spl/stake/stake_history.zig` (v2.2.0)
- **Note**: Now part of SPL Stake program interface

### Integration

- [x] root.zig exports
- [x] 测试通过 (16 new tests, all passing)
- [x] ROADMAP.md 更新

## 完成状态

- 开始日期: 2026-01-03
- 完成日期: 2026-01-03
- 当前状态: ✅ 已完成

## Rust 源码参考

| Zig 模块 | Rust crate |
|----------|-----------|
| epoch_schedule.zig | [epoch-schedule](https://github.com/anza-xyz/solana-sdk/tree/master/epoch-schedule) |
| slot_history.zig | [slot-history](https://github.com/anza-xyz/solana-sdk/tree/master/slot-history) |

## 实现说明

### epoch_schedule.zig
- 实现了完整的 epoch 计算逻辑,包括 warmup 期间的指数增长
- 支持 warmup 和非 warmup 两种模式
- 所有计算方法与 Rust 版本保持一致

### slot_history.zig
- 使用固定大小的位向量 (1M bits = 128KB)
- 实现了循环缓冲区逻辑,自动清理旧数据
- 支持检查 slot 是否存在、被跳过或超出范围
