# Story: v2.0.0 SPL Token & Associated Token Account

> 实现 Solana 最核心的 SPL Token 程序接口，支持代币创建、转账、铸造等操作。

## 目标

实现完整的 SPL Token 和 Associated Token Account 客户端接口：

1. **SPL Token Program** (`TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA`)
   - 状态类型：Mint、Account、Multisig
   - 25 个指令的构建器
   - 错误类型定义

2. **Associated Token Account** (`ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL`)
   - ATA 地址推导
   - 创建指令构建器

## 验收标准

### spl/token/state.zig

- [x] `Mint` 结构体 (82 bytes)
  - [x] mint_authority: COption(PublicKey) - 36 bytes
  - [x] supply: u64 - 8 bytes
  - [x] decimals: u8 - 1 byte
  - [x] is_initialized: bool - 1 byte
  - [x] freeze_authority: COption(PublicKey) - 36 bytes
  - [x] `pack()` 序列化方法
  - [x] `unpack()` 反序列化方法
  - [x] 单元测试

- [x] `Account` (TokenAccount) 结构体 (165 bytes)
  - [x] mint: PublicKey - 32 bytes
  - [x] owner: PublicKey - 32 bytes
  - [x] amount: u64 - 8 bytes
  - [x] delegate: COption(PublicKey) - 36 bytes
  - [x] state: AccountState - 1 byte
  - [x] is_native: COption(u64) - 12 bytes
  - [x] delegated_amount: u64 - 8 bytes
  - [x] close_authority: COption(PublicKey) - 36 bytes
  - [x] `pack()` / `unpack()` 方法
  - [x] `isFrozen()` / `isNative()` 辅助方法
  - [x] 单元测试

- [x] `Multisig` 结构体 (355 bytes)
  - [x] m: u8 - 所需签名数
  - [x] n: u8 - 有效签名者数
  - [x] is_initialized: bool
  - [x] signers: [11]PublicKey - 352 bytes
  - [x] `pack()` / `unpack()` 方法
  - [x] 单元测试

- [x] `AccountState` 枚举
  - [x] Uninitialized = 0
  - [x] Initialized = 1
  - [x] Frozen = 2

- [x] `COption(T)` 通用类型
  - [x] 4-byte tag (0=None, 1=Some) + value
  - [x] `pack()` / `unpack()` for PublicKey
  - [x] `pack()` / `unpack()` for u64

### spl/token/instruction.zig

- [x] 指令枚举 `TokenInstruction`
  - [x] InitializeMint = 0
  - [x] InitializeAccount = 1
  - [x] InitializeMultisig = 2
  - [x] Transfer = 3
  - [x] Approve = 4
  - [x] Revoke = 5
  - [x] SetAuthority = 6
  - [x] MintTo = 7
  - [x] Burn = 8
  - [x] CloseAccount = 9
  - [x] FreezeAccount = 10
  - [x] ThawAccount = 11
  - [x] TransferChecked = 12
  - [x] ApproveChecked = 13
  - [x] MintToChecked = 14
  - [x] BurnChecked = 15
  - [x] InitializeAccount2 = 16
  - [x] SyncNative = 17
  - [x] InitializeAccount3 = 18
  - [x] InitializeMultisig2 = 19
  - [x] InitializeMint2 = 20
  - [x] GetAccountDataSize = 21
  - [x] InitializeImmutableOwner = 22
  - [x] AmountToUiAmount = 23
  - [x] UiAmountToAmount = 24

- [x] 指令构建器函数
  - [x] `initializeMint()` / `initializeMint2()`
  - [x] `initializeAccount()` / `initializeAccount2()` / `initializeAccount3()`
  - [x] `transfer()` / `transferChecked()`
  - [x] `approve()` / `approveChecked()`
  - [x] `revoke()`
  - [x] `setAuthority()`
  - [x] `mintTo()` / `mintToChecked()`
  - [x] `burn()` / `burnChecked()`
  - [x] `closeAccount()`
  - [x] `freezeAccount()` / `thawAccount()`
  - [x] `syncNative()`

- [x] `AuthorityType` 枚举
  - [x] MintTokens = 0
  - [x] FreezeAccount = 1
  - [x] AccountOwner = 2
  - [x] CloseAccount = 3

- [x] 单元测试（每个指令至少一个测试）

### spl/token/error.zig

- [x] `TokenError` 枚举
  - [x] NotRentExempt = 0
  - [x] InsufficientFunds = 1
  - [x] InvalidMint = 2
  - [x] MintMismatch = 3
  - [x] OwnerMismatch = 4
  - [x] FixedSupply = 5
  - [x] AlreadyInUse = 6
  - [x] InvalidNumberOfProvidedSigners = 7
  - [x] InvalidNumberOfRequiredSigners = 8
  - [x] UninitializedState = 9
  - [x] NativeNotSupported = 10
  - [x] NonNativeHasBalance = 11
  - [x] InvalidInstruction = 12
  - [x] InvalidState = 13
  - [x] Overflow = 14
  - [x] AuthorityTypeNotSupported = 15
  - [x] MintCannotFreeze = 16
  - [x] AccountFrozen = 17
  - [x] MintDecimalsMismatch = 18
  - [x] NonNativeNotSupported = 19

### spl/token/root.zig

- [x] 导出所有类型和函数
- [x] Program ID 常量 `TOKEN_PROGRAM_ID`

### spl/associated_token.zig

- [x] Program ID 常量 `ASSOCIATED_TOKEN_PROGRAM_ID`
- [x] `findAssociatedTokenAddress()` - PDA 推导
  - [x] seeds = [wallet, token_program_id, mint]
- [x] `create()` - Create instruction (ID=0)
- [x] `createIdempotent()` - CreateIdempotent instruction (ID=1)
- [x] `recoverNested()` - RecoverNested instruction (ID=2)
- [x] 单元测试

### spl/root.zig

- [x] 导出 token 子模块
- [x] 导出 associated_token 模块

### 集成

- [x] client/src/root.zig 导出 spl 模块
- [x] 文档更新 (docs/design/spl-token.md)
- [x] 所有测试通过 (`./solana-zig/zig build test`)

## Rust 源码引用

| 模块 | Rust 源码 |
|------|----------|
| state.zig | https://github.com/solana-program/token/blob/master/interface/src/state.rs |
| instruction.zig | https://github.com/solana-program/token/blob/master/interface/src/instruction.rs |
| error.zig | https://github.com/solana-program/token/blob/master/interface/src/error.rs |
| associated_token.zig | https://github.com/solana-program/associated-token-account/blob/master/interface/src/instruction.rs |

## 数据结构规范

### COption 编码格式

```
COption<Pubkey> (36 bytes):
  [tag: 4 bytes][value: 32 bytes]
  tag = 0x00000000 -> None
  tag = 0x01000000 -> Some(pubkey)

COption<u64> (12 bytes):
  [tag: 4 bytes][value: 8 bytes]
  tag = 0x00000000 -> None
  tag = 0x01000000 -> Some(amount)
```

### Mint 内存布局 (82 bytes)

```
Offset | Size | Field
-------|------|-------
0      | 36   | mint_authority (COption<Pubkey>)
36     | 8    | supply (u64, little-endian)
44     | 1    | decimals (u8)
45     | 1    | is_initialized (bool)
46     | 36   | freeze_authority (COption<Pubkey>)
```

### Account 内存布局 (165 bytes)

```
Offset | Size | Field
-------|------|-------
0      | 32   | mint (Pubkey)
32     | 32   | owner (Pubkey)
64     | 8    | amount (u64)
72     | 36   | delegate (COption<Pubkey>)
108    | 1    | state (AccountState)
109    | 12   | is_native (COption<u64>)
121    | 8    | delegated_amount (u64)
129    | 36   | close_authority (COption<Pubkey>)
```

## 完成状态

- 开始日期: 2026-01-07
- 完成日期: 2026-01-07
- 状态: ✅ 已完成
