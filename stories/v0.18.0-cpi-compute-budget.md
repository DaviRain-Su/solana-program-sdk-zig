# Story: v0.18.0 CPI, Compute Budget & Stack Optimization

> CPI 增强、计算预算接口、原生代币工具，以及关键的栈溢出修复

## 目标

1. 增强 CPI (跨程序调用) 功能，支持返回数据
2. 实现 Compute Budget 程序接口
3. 实现 Native Token 工具模块
4. 修复栈溢出风险，将账户数组从栈移到堆

## 验收标准

### CPI 增强 (instruction.zig)

- [x] `MAX_RETURN_DATA` 常量 (1024 bytes)
- [x] `ReturnData` 结构体
- [x] `setReturnData()` 函数
- [x] `getReturnData()` 函数
- [x] `getReturnDataStatic()` 便捷函数
- [x] 单元测试

### Compute Budget 模块 (compute_budget.zig)

- [x] 程序 ID: `ComputeBudget111111111111111111111111111111`
- [x] `ComputeBudgetInstruction` 枚举
- [x] 常量: `MAX_COMPUTE_UNIT_LIMIT`, `DEFAULT_INSTRUCTION_COMPUTE_UNIT_LIMIT`, etc.
- [x] `requestHeapFrame()` 指令构建器
- [x] `setComputeUnitLimit()` 指令构建器
- [x] `setComputeUnitPrice()` 指令构建器
- [x] `setLoadedAccountsDataSizeLimit()` 指令构建器
- [x] 完整的序列化测试
- [x] 单元测试通过

### Native Token 模块 (native_token.zig)

- [x] `LAMPORTS_PER_SOL` 常量 (1,000,000,000)
- [x] `SOL_DECIMALS` 常量 (9)
- [x] `Sol` 显示包装类型
- [x] `Sol.format()` 格式化方法 (◎1.500000000)
- [x] `solStrToLamports()` 字符串解析函数
- [x] `lamportsToSol()` 转换函数
- [x] `solToLamports()` 转换函数
- [x] 边界条件测试 (溢出、负数、无效格式)
- [x] 单元测试通过

### 栈溢出修复 (context.zig)

- [x] `Context.accounts` 从 `[MAX_ACCOUNTS]Account` 改为 `[]Account`
- [x] BPF 模式使用堆分配 (`heap_allocator.alloc`)
- [x] 测试模式使用静态缓冲区
- [x] 栈使用从 ~3KB 降至 16 bytes
- [x] 文档注释解释优化原因
- [x] 单元测试通过

### 集成

- [x] root.zig 导出 `compute_budget` 模块
- [x] root.zig 导出 `native_token` 模块
- [x] root.zig 导出 CPI 相关函数
- [x] 所有测试通过 (`zig build test`)
- [x] BPF 程序测试通过 (`cargo test`)

### 文档更新

- [x] ROADMAP.md 更新覆盖率统计
- [x] ROADMAP.md 添加 v0.18.0 版本历史
- [x] 创建 Story 文件

## 技术亮点

### 零拷贝设计 (对标 solana-nostd-entrypoint)

本 SDK 实现了与 Rust `solana-nostd-entrypoint` 相同的优化:

1. **零拷贝反序列化**: 直接指针转换，无 memcpy
2. **零堆分配**: 账户数组在 BPF 中使用 32KB 堆
3. **内存布局对齐**: `extern struct` + comptime 验证
4. **无 RefCell 开销**: Zig 原生无此概念

### 栈空间节省

| 场景 | 之前 | 之后 | 节省 |
|------|------|------|------|
| 账户数组 | ~3072 bytes | 16 bytes | 99.5% |
| 可用栈空间 | ~1KB | ~4KB | 75% 恢复 |

## 完成状态

- 开始日期: 2026-01-05
- 完成日期: 2026-01-05
- 状态: ✅ 已完成

## 相关提交

- `61a757d` - feat: v0.18.0 - CPI enhancements, compute budget, native token, and stack optimization
