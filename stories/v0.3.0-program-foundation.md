# Story: v0.3.0 Program Foundation

> Core program types and utilities for building Solana programs

## 目标

Complete the foundational types and utilities needed for Solana program development, including error handling, instruction building, and account management.

## 验收标准

### error.zig (Program Error)

- [x] ProgramError enum with all 26 builtin variants
- [x] Error code constants matching Rust SDK
- [x] toU64() and fromU64() conversions
- [x] custom() for creating custom errors
- [x] getCustomCode() for extracting custom error codes
- [x] isBuiltin() to check error type
- [x] toString() for human-readable messages
- [x] ProgramResult type alias
- [x] Unit tests

### instruction.zig (Instructions & CPI)

- [x] Instruction struct for CPI
- [x] InstructionData helper for packed data
- [x] AccountMeta type with constructors
- [x] TRANSACTION_LEVEL_STACK_HEIGHT constant
- [x] ProcessedSiblingInstruction struct
- [x] invoke() for CPI
- [x] invokeSigned() for PDA signing
- [x] Unit tests

### account.zig (Account Types)

- [x] Account.Data extern struct matching runtime layout
- [x] Account.Param for instruction account metadata
- [x] Account.Info for CPI
- [x] Account wrapper with utility methods
- [x] id(), lamports(), ownerId(), data() accessors
- [x] isWritable(), isExecutable(), isSigner() checks
- [x] realloc() with bounds checking
- [x] info() to create Account.Info
- [x] Unit tests

### Integration

- [x] root.zig exports (ProgramError, Account, Instruction)
- [x] 文档更新 (ROADMAP.md updated)
- [x] 测试通过

## 完成状态

- 开始日期: 2026-01-03
- 完成日期: 2026-01-03
- 当前状态: ✅ 已完成
- 备注: program_memory and program_pack deferred to Phase 10 (legacy/optional)

## 设计决策

### Error Handling
- Use u64 enum for compatibility with Solana runtime
- Builtin errors use upper 32 bits
- Custom errors use lower 32 bits

### Instruction Building
- Support both BPF runtime (extern calls) and native execution
- InstructionData provides type-safe discriminant+data packing

### Account Layout
- Match exact byte layout expected by Solana BPF runtime
- DATA_HEADER constant = 88 bytes
- Account data follows header in memory

## Rust 源码参考

| Zig 模块 | Rust crate |
|----------|-----------|
| error.zig | [program-error](https://github.com/anza-xyz/solana-sdk/tree/master/program-error) |
| instruction.zig | [instruction](https://github.com/anza-xyz/solana-sdk/tree/master/instruction) |
| account.zig | [account-info](https://github.com/anza-xyz/solana-sdk/tree/master/account-info) |
