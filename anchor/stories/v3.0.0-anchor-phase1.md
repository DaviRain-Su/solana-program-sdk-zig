# Story: v3.0.0 sol-anchor-zig Phase 1 - Core Framework

> 实现 Anchor 风格的 Solana 程序开发框架，使用 Zig 的 comptime 元编程替代 Rust 的过程宏。

## 目标

实现 sol-anchor-zig Phase 1 核心框架，提供 Anchor 兼容的开发模式：

1. **Discriminator 生成** - SHA256 sighash 账户/指令标识符
2. **Account 包装器** - 类型安全的账户数据访问
3. **Signer/Program 类型** - 签名者和程序账户验证
4. **Context 上下文** - 指令处理上下文
5. **Constraints 约束** - 声明式账户验证
6. **Error 错误码** - Anchor 兼容的错误码

## 验收标准

### anchor/src/discriminator.zig

- [x] `DISCRIMINATOR_LENGTH` 常量 (8 bytes)
- [x] `Discriminator` 类型 ([8]u8)
- [x] `accountDiscriminator(name)` - `sha256("account:<name>")[0..8]`
- [x] `instructionDiscriminator(name)` - `sha256("global:<name>")[0..8]`
- [x] `sighash(namespace, name)` - 通用 sighash 生成
- [x] 编译期计算 (comptime)
- [x] 单元测试

### anchor/src/error.zig

- [x] `AnchorError` 枚举
  - [x] Instruction errors (100-199)
    - [x] InstructionMissing = 100
    - [x] InstructionFallbackNotFound = 101
    - [x] InstructionDidNotDeserialize = 102
    - [x] InstructionDidNotSerialize = 103
  - [x] Constraint errors (2000-2999)
    - [x] ConstraintMut = 2000
    - [x] ConstraintHasOne = 2001
    - [x] ConstraintSigner = 2002
    - [x] ConstraintRaw = 2003
    - [x] ConstraintOwner = 2004
    - [x] ConstraintAddress = 2005
    - [x] ConstraintSeeds = 2006
    - [x] ConstraintExecutable = 2007
    - [x] ... (完整列表)
  - [x] Account errors (3000-3999)
    - [x] AccountDiscriminatorMismatch = 3000
    - [x] AccountDiscriminatorNotFound = 3001
    - [x] AccountNotInitialized = 3002
    - [x] ... (完整列表)
- [x] `CUSTOM_ERROR_BASE` 常量 (6000)
- [x] `customErrorCode(offset)` 辅助函数
- [x] `toU32()` / `fromU32()` 转换方法
- [x] `message()` 获取错误消息
- [x] 单元测试

### anchor/src/constraints.zig

- [x] `Constraints` 结构体
  - [x] `mut: bool` - 账户必须可写
  - [x] `signer: bool` - 账户必须是签名者
  - [x] `owner: ?PublicKey` - 账户所有者约束
  - [x] `address: ?PublicKey` - 账户地址约束
  - [x] `executable: bool` - 可执行约束
  - [ ] `rent_exempt` - 延迟到后续阶段 (需要 Rent sysvar)
- [x] `validateConstraints(info, constraints)` - 验证所有约束
- [x] `validateConstraintsOrError(info, constraints)` - 返回错误联合
- [x] `ConstraintError` 错误类型
- [x] 单元测试

### anchor/src/account.zig

- [x] `AccountConfig` 配置结构体
  - [x] `discriminator: Discriminator` - 8 字节标识符
  - [x] `owner: ?PublicKey` - 可选所有者约束
  - [x] `space: ?usize` - 可选空间覆盖
- [x] `Account(T, config)` 泛型包装器
  - [x] `discriminator` 常量
  - [x] `SPACE` 常量 (8 + @sizeOf(T))
  - [x] `DataType` 类型别名
  - [x] `info` 字段 - 账户信息指针
  - [x] `data` 字段 - 类型化数据指针
  - [x] `load(info)` - 加载并验证
  - [x] `loadUnchecked(info)` - 无验证加载
  - [x] `init(info)` - 初始化新账户
  - [x] `key()` / `owner()` / `lamports()` 访问器
  - [x] `isMut()` / `isSigner()` / `isExecutable()` 检查
  - [x] `toAccountInfo()` / `rawData()` 转换
- [x] `AccountError` 错误类型
- [x] 单元测试

### anchor/src/signer.zig

- [x] `Signer` 结构体
  - [x] `info` 字段
  - [x] `load(info)` - 验证 is_signer
  - [x] `key()` / `lamports()` / `isMut()` 访问器
  - [x] `toAccountInfo()` 转换
- [x] `SignerMut` 结构体
  - [x] `load(info)` - 验证 is_signer + is_writable
- [x] `SignerWith(config)` 可配置签名者
- [x] `SignerConfig` 配置
- [x] `SignerError` 错误类型
- [x] 单元测试

### anchor/src/program.zig

- [x] `Program(expected_id)` 泛型类型
  - [x] `ID` 常量 - 编译期程序 ID
  - [x] `info` 字段
  - [x] `load(info)` - 验证 executable + ID 匹配
  - [x] `key()` / `toAccountInfo()` 访问器
- [x] `UncheckedProgram` 结构体
  - [x] `load(info)` - 仅验证 executable
- [x] `ProgramError` 错误类型
- [x] 单元测试

### anchor/src/context.zig

- [x] `Bumps` 结构体
  - [x] 存储 PDA bump seeds
  - [x] `get(name)` / `set(name, bump)` 方法
- [x] `Context(Accounts)` 泛型类型
  - [x] `accounts` 字段 - 解析后的账户
  - [x] `program_id` 字段 - 程序 ID
  - [x] `remaining_accounts` 字段 - 剩余账户
  - [x] `bumps` 字段 - bump seeds
  - [x] `new()` / `fromAccounts()` 构造器
  - [x] `getBump(field_name)` 方法
- [x] `loadAccounts(Accounts, infos)` - 解析账户结构体
- [x] `parseContext(Accounts, program_id, infos)` - 完整上下文解析
- [x] `ContextError` 错误类型
- [x] 单元测试

### anchor/src/root.zig

- [x] 导出所有子模块
- [x] 导出常用类型和函数
- [x] 模块文档
- [x] 使用示例
- [x] 单元测试

### 集成

- [x] `anchor/src/root.zig` 导出所有模块
- [x] 所有测试通过

## Rust 源码引用

| 模块 | Rust 源码 |
|------|----------|
| discriminator.zig | https://github.com/coral-xyz/anchor/blob/master/lang/attribute/account/src/lib.rs |
| error.zig | https://github.com/coral-xyz/anchor/blob/master/lang/src/error.rs |
| account.zig | https://github.com/coral-xyz/anchor/blob/master/lang/src/accounts/account.rs |
| signer.zig | https://github.com/coral-xyz/anchor/blob/master/lang/src/accounts/signer.rs |
| program.zig | https://github.com/coral-xyz/anchor/blob/master/lang/src/accounts/program.rs |
| context.zig | https://github.com/coral-xyz/anchor/blob/master/lang/src/context.rs |
| constraints.zig | https://github.com/coral-xyz/anchor/blob/master/lang/syn/src/codegen/accounts/constraints.rs |

## 架构设计

### Discriminator 生成

```
Anchor 格式:
- 账户: sha256("account:<AccountName>")[0..8]
- 指令: sha256("global:<instruction_name>")[0..8]

Zig 实现:
pub fn accountDiscriminator(comptime name: []const u8) Discriminator {
    comptime {
        var hash: [32]u8 = undefined;
        std.crypto.hash.sha2.Sha256.hash("account:" ++ name, &hash, .{});
        return hash[0..8].*;
    }
}
```

### Account 内存布局

```
Offset | Size | Field
-------|------|-------
0      | 8    | discriminator
8      | N    | data (T)
```

### 错误码范围 (Anchor 兼容)

```
Range       | Category
------------|------------------
100-199     | Instruction errors
1000-1999   | IDL errors (not implemented)
2000-2999   | Constraint errors
3000-3999   | Account errors
4100-4999   | Misc errors (not implemented)
6000+       | Custom user errors
```

## 使用示例

```zig
const anchor = @import("sol_anchor_zig");
const sol = anchor.sdk;

// 定义账户数据
const CounterData = struct {
    count: u64,
    authority: sol.PublicKey,
};

// 创建类型安全的账户包装器
const Counter = anchor.Account(CounterData, .{
    .discriminator = anchor.accountDiscriminator("Counter"),
});

// 定义指令账户
const InitializeAccounts = struct {
    authority: anchor.Signer,
    counter: Counter,
    system_program: anchor.Program(sol.system_program.ID),
};

// 指令处理函数
fn initialize(ctx: anchor.Context(InitializeAccounts)) !void {
    const counter = ctx.accounts.counter;
    counter.data.count = 0;
    counter.data.authority = ctx.accounts.authority.key().*;
}
```

## 后续阶段

### Phase 2: PDA 支持
- `seeds` 约束
- `bump` 自动发现
- `init` 账户创建

### Phase 3: 高级功能
- `has_one` 关联验证
- `constraint` 自定义表达式
- `close` 账户关闭
- `realloc` 重新分配

## 完成状态

- 开始日期: 2026-01-08
- 完成日期: 2026-01-08
- 状态: ✅ 已完成
