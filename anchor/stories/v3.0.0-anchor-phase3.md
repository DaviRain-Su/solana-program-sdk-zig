# Story: v3.0.0 sol-anchor-zig Phase 3 - Advanced Constraints

> 实现高级约束支持，包括 has_one 字段验证、close 账户关闭和 realloc 账户重新分配。

## 目标

实现 sol-anchor-zig Phase 3 高级约束，提供 Anchor 兼容的约束验证模式：

1. **has_one 约束** - 验证账户数据字段匹配其他账户公钥
2. **close 约束** - 关闭账户并转移 lamports 到目标账户
3. **realloc 约束** - 动态调整账户大小，处理租金支付/退款

## 验收标准

### anchor/src/has_one.zig

- [x] `HasOneSpec` 结构体
  - [x] `field: []const u8` - 账户数据中的字段名
  - [x] `target: []const u8` - Accounts 结构体中的账户名
- [x] `validateHasOne(T, data, field_name, target_key)` - 验证单个 has_one
- [x] `validateHasOneBytes` - 验证原始字节
- [x] 支持 PublicKey 字段类型
- [x] 支持 [32]u8 字段类型
- [x] `HasOneError` 错误类型
- [x] 单元测试 (8 tests)

### anchor/src/close.zig

- [x] `CloseError` 错误类型
  - [x] `AccountNotWritable` - 账户不可写
  - [x] `DestinationNotWritable` - 目标账户不可写
  - [x] `CloseToSelf` - 不能关闭到自己
- [x] `closeAccount(account, destination)` - 关闭账户
  - [x] 转移所有 lamports 到目标
  - [x] 清零所有账户数据
- [x] `close(AccountType, account, destination)` - 类型化关闭
- [x] `canClose` - 检查是否可关闭
- [x] `getCloseRefund` - 获取退款金额
- [x] `isClosed` - 检查是否已关闭
- [x] 单元测试 (8 tests)

### anchor/src/realloc.zig

- [x] `ReallocError` 错误类型
  - [x] `AccountNotWritable` - 账户不可写
  - [x] `PayerNotSigner` - 付款账户非签名者
  - [x] `SizeExceedsMax` - 超过最大大小
  - [x] `ZeroSize` - 不允许零大小
  - [x] `InsufficientPayer` - 付款账户余额不足
  - [x] `InsufficientRent` - 租金不足
- [x] `MAX_ACCOUNT_SIZE` 常量 (10 MB)
- [x] `ReallocConfig` 配置结构体
  - [x] `payer: ?[]const u8` - 付款账户
  - [x] `zero_init: bool` - 是否零初始化
- [x] `reallocAccount(account, new_size, payer, zero_init)` - 重新分配
  - [x] 增长时从付款账户收取额外租金
  - [x] 缩小时退还多余租金
- [x] `calculateRentDiff` - 计算租金差异
- [x] `rentForSize` - 获取指定大小的租金
- [x] `validateRealloc` - 验证重分配操作
- [x] 单元测试 (13 tests)

### anchor/src/account.zig 扩展

- [x] `AccountConfig` 新增字段
  - [x] `has_one: ?[]const HasOneSpec` - has_one 约束规范
  - [x] `close: ?[]const u8` - 关闭目标账户字段名
  - [x] `realloc: ?ReallocConfig` - 重新分配配置
- [x] `HAS_HAS_ONE` 常量 - 是否有 has_one 约束
- [x] `HAS_CLOSE` 常量 - 是否有 close 约束
- [x] `HAS_REALLOC` 常量 - 是否有 realloc 约束
- [x] 编译期配置验证
- [x] 单元测试

### anchor/src/root.zig

- [x] 导出 has_one 模块
- [x] 导出 close 模块
- [x] 导出 realloc 模块
- [x] 更新文档和示例
- [x] Phase 3 子模块测试

### 集成

- [x] 所有测试通过 (508 tests)
- [x] 与 Phase 1/Phase 2 向后兼容

## Rust 源码引用

| 模块 | Rust 源码 |
|------|----------|
| has_one.zig | https://github.com/coral-xyz/anchor/blob/master/lang/syn/src/codegen/accounts/constraints.rs |
| close.zig | https://github.com/coral-xyz/anchor/blob/master/lang/syn/src/codegen/accounts/close.rs |
| realloc.zig | https://github.com/coral-xyz/anchor/blob/master/lang/syn/src/codegen/accounts/realloc.rs |

## 架构设计

### has_one 约束

```
Anchor 格式:
#[account(
    has_one = authority,
)]

Zig 等价:
const Vault = anchor.Account(VaultData, .{
    .discriminator = anchor.accountDiscriminator("Vault"),
    .has_one = &.{
        .{ .field = "authority", .target = "authority" },
    },
});
```

### has_one 验证流程

```
1. 加载账户数据后，获取 has_one 规范
2. 对每个规范:
   a. 获取账户数据中的字段值
   b. 获取目标账户的公钥
   c. 比较两者是否相等
3. 任一不匹配则返回 ConstraintHasOne 错误
```

### close 约束

```
Anchor 格式:
#[account(
    mut,
    close = destination,
)]

Zig 等价:
const Closeable = anchor.Account(Data, .{
    .discriminator = anchor.accountDiscriminator("Closeable"),
    .close = "destination",
});
```

### close 执行流程

```
1. 验证账户可写
2. 验证目标账户可写
3. 验证不是关闭到自己
4. 转移所有 lamports 到目标账户
5. 清零所有账户数据
6. (运行时自动将 owner 设为 system program)
```

### realloc 约束

```
Anchor 格式:
#[account(
    mut,
    realloc = new_size,
    realloc::payer = payer,
    realloc::zero = true,
)]

Zig 等价:
const Dynamic = anchor.Account(Data, .{
    .discriminator = anchor.accountDiscriminator("Dynamic"),
    .realloc = .{
        .payer = "payer",
        .zero_init = true,
    },
});
```

### realloc 执行流程

```
1. 验证账户可写
2. 验证新大小有效 (> 0, <= 10MB)
3. 计算租金差异
4. 如果增长:
   a. 验证付款账户是签名者
   b. 从付款账户转移额外租金
   c. 零初始化新空间 (如配置)
5. 如果缩小:
   a. 退还多余租金到付款账户
6. 更新数据长度
```

## 使用示例

### has_one 约束

```zig
const anchor = @import("sol_anchor_zig");
const sol = anchor.sdk;

// 账户数据带 authority 字段
const VaultData = struct {
    authority: sol.PublicKey,
    balance: u64,
};

// 带 has_one 约束的 Vault 账户
const Vault = anchor.Account(VaultData, .{
    .discriminator = anchor.accountDiscriminator("Vault"),
    .has_one = &.{
        .{ .field = "authority", .target = "authority" },
    },
});

const WithdrawAccounts = struct {
    vault: Vault,
    authority: anchor.Signer,  // 必须匹配 vault.authority
};

fn withdraw(ctx: anchor.Context(WithdrawAccounts), amount: u64) !void {
    // has_one 在加载时自动验证
    ctx.accounts.vault.data.balance -= amount;
}
```

### close 约束

```zig
const CloseableData = struct {
    value: u64,
};

const Closeable = anchor.Account(CloseableData, .{
    .discriminator = anchor.accountDiscriminator("Closeable"),
    .close = "destination",
});

const CloseAccounts = struct {
    closeable: Closeable,
    destination: anchor.SignerMut,
};

fn closeAccount(ctx: anchor.Context(CloseAccounts)) !void {
    // 手动关闭
    try anchor.close.closeAccount(
        ctx.accounts.closeable.toAccountInfo(),
        ctx.accounts.destination.toAccountInfo(),
    );
}
```

### realloc 约束

```zig
const DynamicData = struct {
    len: u32,
    // 可变长度数据跟随
};

const Dynamic = anchor.Account(DynamicData, .{
    .discriminator = anchor.accountDiscriminator("Dynamic"),
    .realloc = .{
        .payer = "payer",
        .zero_init = true,
    },
});

const ResizeAccounts = struct {
    dynamic: Dynamic,
    payer: anchor.SignerMut,
};

fn resize(ctx: anchor.Context(ResizeAccounts), new_size: u32) !void {
    try anchor.realloc.reallocAccount(
        ctx.accounts.dynamic.toAccountInfo(),
        new_size,
        ctx.accounts.payer.toAccountInfo(),
        true,
    );
}
```

## 测试用例

### has_one.zig 测试

1. **字段匹配**
   - 字段值与目标账户公钥匹配 → 成功
   - 字段值与目标账户公钥不匹配 → ConstraintHasOne 错误

2. **多个 has_one**
   - 所有都匹配 → 成功
   - 任一不匹配 → 错误

3. **字段类型**
   - PublicKey 类型字段正常工作
   - [32]u8 类型字段正常工作

### close.zig 测试

1. **成功关闭**
   - lamports 全部转移
   - 数据全部清零

2. **验证检查**
   - 账户不可写 → AccountNotWritable
   - 目标不可写 → DestinationNotWritable
   - 关闭到自己 → CloseToSelf

### realloc.zig 测试

1. **增长账户**
   - 额外租金从付款账户扣除
   - 新空间零初始化

2. **缩小账户**
   - 多余租金退还到付款账户

3. **验证检查**
   - 账户不可写 → AccountNotWritable
   - 付款账户非签名者 → PayerNotSigner
   - 大小超过最大值 → SizeExceedsMax
   - 零大小 → ZeroSize

## 依赖

已实现的模块:
- Phase 1: `Account`, `Signer`, `Context`, `Constraints`, `Error`
- Phase 2: `Seeds`, `PDA`, `Init`, `Bumps`
- `src/rent.zig` - Rent 计算
- `src/system_program.zig` - System Program

## 后续阶段

### Phase 4: 序列化
- Borsh 序列化支持
- 自动派生序列化
- 零拷贝账户访问
- 指令参数解析

### Phase 5: 开发者体验
- IDL 编译期生成
- 客户端代码生成
- 错误消息与源位置
- 测试工具

## 完成状态

- 开始日期: 2026-01-08
- 完成日期: 2026-01-08
- 状态: ✅ 已完成
