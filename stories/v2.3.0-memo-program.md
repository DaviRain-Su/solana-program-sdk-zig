# Story: v2.3.0 SPL Memo Program

> 实现 SPL Memo 程序接口，用于在交易中附加任意 UTF-8 文本备注。

## 目标

实现 SPL Memo 程序的客户端接口：

**Program ID**: `MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr`

**Source**: https://github.com/solana-program/memo

### 特点

- 最简单的 SPL 程序之一
- 无指令判别符（data 直接是 UTF-8 字节）
- 可选的签名者验证
- Token-2022 备注转账扩展集成

## 验收标准

### spl/memo.zig

- [x] 常量定义
  - [x] `MEMO_PROGRAM_ID` - Program ID
  - [x] `MEMO_V1_PROGRAM_ID` - 旧版 Program ID

- [x] 指令构建函数
  - [x] `MemoInstruction.init(memo)` - 创建 memo 指令
  - [x] `MemoInstruction.initValidated(memo)` - 创建 memo 指令（带 UTF-8 验证）
  - [x] `MemoInstruction.getData()` - 获取原始 UTF-8 字节
  - [x] `MemoInstruction.getProgramId()` - 获取 program ID
  - [x] `MemoInstruction.createSignerAccounts()` - 创建签名者账户元数据

- [x] UTF-8 验证
  - [x] `isValidUtf8()` - 验证 memo 是有效的 UTF-8 字符串
  - [x] `findInvalidUtf8Position()` - 查找无效 UTF-8 位置

- [x] 单元测试 (11 tests)
  - [x] 测试 Program ID 值正确
  - [x] 测试简单文本 memo
  - [x] 测试空 memo
  - [x] 测试带 emoji 的 memo（多字节 UTF-8）
  - [x] 测试 UTF-8 验证 - 有效 ASCII
  - [x] 测试 UTF-8 验证 - 有效 emoji
  - [x] 测试 UTF-8 验证 - 无效字节
  - [x] 测试 isValidUtf8 辅助函数
  - [x] 测试 findInvalidUtf8Position 辅助函数
  - [x] 测试 createSignerAccounts 创建签名者
  - [x] 测试 createSignerAccounts 空签名者

### spl/root.zig

- [x] 导出 `memo` 模块
- [x] 添加 `MEMO_PROGRAM_ID` 便捷重导出

### 集成

- [x] `root.zig` 导出
- [x] ROADMAP.md 更新
- [x] CHANGELOG.md 更新
- [x] 所有测试通过 (`./solana-zig/zig build test`) - 294 tests

## 技术细节

### Rust SDK 参考

```rust
// https://github.com/solana-program/memo/blob/master/interface/src/lib.rs

/// Program ID
pub mod program {
    solana_pubkey::declare_id!("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr");
}

/// Build a memo instruction
/// 
/// Accounts:
/// - signers: All signer accounts (if any)
///
/// Data: UTF-8 encoded string
pub fn build_memo(memo: &[u8], signer_pubkeys: &[&Pubkey]) -> Instruction {
    Instruction {
        program_id: id(),
        accounts: signer_pubkeys
            .iter()
            .map(|&pubkey| AccountMeta::new_readonly(*pubkey, true))
            .collect(),
        data: memo.to_vec(),
    }
}
```

### Zig 实现计划

```zig
// sdk/src/spl/memo.zig
//! SPL Memo Program
//!
//! Rust source: https://github.com/solana-program/memo/blob/master/interface/src/lib.rs

const std = @import("std");
const PublicKey = @import("../public_key.zig").PublicKey;
const Instruction = @import("../instruction.zig").Instruction;
const AccountMeta = @import("../instruction.zig").AccountMeta;

/// SPL Memo Program ID (v2)
pub const MEMO_PROGRAM_ID = PublicKey.comptimeFromBase58("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr");

/// SPL Memo Program ID (v1, legacy)
pub const MEMO_V1_PROGRAM_ID = PublicKey.comptimeFromBase58("Memo1UhkJRfHyvLMcVucJwxXeuD728EqVDDwQDxFMNo");

/// Build a memo instruction with optional signers
///
/// All signers must sign the transaction for it to be valid.
/// The memo data is the raw UTF-8 bytes (no instruction discriminator).
pub fn buildMemoInstruction(memo: []const u8, signers: []const PublicKey) Instruction {
    // ...
}

/// Build a memo instruction without signers
pub fn buildMemo(memo: []const u8) Instruction {
    return buildMemoInstruction(memo, &[_]PublicKey{});
}
```

## 依赖

- `sdk/src/public_key.zig` - PublicKey 类型
- `sdk/src/instruction.zig` - Instruction, AccountMeta 类型

## 完成状态

- 开始日期: 2026-01-07
- 完成日期: 2026-01-07
- 状态: ✅ 已完成
