# Story: v1.1.0 Client SDK 实现

> 实现 Solana RPC Client SDK，支持链下交易构建和提交

## 背景

当前项目已完成：
- `sdk/` - 共享核心类型（无 syscall 依赖）
- `src/` - Program SDK（含 syscall，用于链上程序）

缺少 Client SDK，无法进行链下开发（构建交易、查询账户、提交交易等）。

## 目标架构

```
┌─────────────────────────────────────┐
│  sdk/ (共享核心类型)                  │
│  PublicKey, Hash, Signature, etc.   │
└─────────────────────────────────────┘
         ▲                 ▲
         │                 │
┌────────┴────────┐  ┌────┴────────────┐
│ src/ (Program)  │  │ client/ (Client)│
│ syscalls, CPI   │  │ RPC, signing    │
└─────────────────┘  └─────────────────┘
```

## 模块规划

### Phase 1: 基础设施

| 模块 | 说明 | 依赖 |
|------|------|------|
| `client/src/json_rpc.zig` | JSON-RPC 协议实现 | std.http, std.json |
| `client/src/error.zig` | 错误类型定义 | - |
| `client/src/config.zig` | CommitmentConfig 等配置 | - |

### Phase 2: 核心 RPC 方法

| 模块 | 说明 | RPC 方法 |
|------|------|---------|
| `client/src/rpc_client.zig` | RPC Client 主体 | - |
| - | getBalance | 查询余额 |
| - | getLatestBlockhash | 获取最新区块哈希 |
| - | getAccountInfo | 查询账户信息 |
| - | sendTransaction | 发送交易 |
| - | getSignatureStatuses | 查询交易状态 |

### Phase 3: 交易构建

| 模块 | 说明 | 依赖 |
|------|------|------|
| `client/src/transaction_builder.zig` | 交易构建器 | sdk.Transaction |
| `client/src/signer.zig` | 交易签名 | sdk.Keypair |

## 验收标准

### Phase 1: 基础设施 ⏳

- [ ] 创建 `client/` 目录结构
- [ ] 创建 `client/build.zig` 和 `client/build.zig.zon`
- [ ] 实现 `error.zig` - ClientError, RpcError
- [ ] 实现 `config.zig` - CommitmentConfig, RpcClientConfig
- [ ] 实现 `json_rpc.zig` - JSON-RPC 请求/响应处理
- [ ] 基础测试通过

### Phase 2: 核心 RPC ⏳

- [ ] 实现 `rpc_client.zig` 基础结构
- [ ] 实现 `getBalance` 方法
- [ ] 实现 `getLatestBlockhash` 方法
- [ ] 实现 `getAccountInfo` 方法
- [ ] 实现 `sendTransaction` 方法
- [ ] 实现 `getSignatureStatuses` 方法
- [ ] RPC 方法测试（mock server 或 devnet）

### Phase 3: 交易构建 ⏳

- [ ] 实现 `transaction_builder.zig`
- [ ] 实现 `signer.zig` - Ed25519 签名
- [ ] 端到端测试：构建 → 签名 → 发送 → 确认

## 技术设计

### JSON-RPC 请求格式

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "getBalance",
  "params": ["PublicKeyBase58", {"commitment": "confirmed"}]
}
```

### JSON-RPC 响应格式

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "context": {"slot": 123456},
    "value": 1000000000
  }
}
```

### CommitmentConfig

```zig
pub const Commitment = enum {
    processed,
    confirmed,
    finalized,
};

pub const CommitmentConfig = struct {
    commitment: Commitment = .confirmed,
};
```

### RpcClient 结构

```zig
pub const RpcClient = struct {
    allocator: std.mem.Allocator,
    endpoint: []const u8,
    commitment: CommitmentConfig,
    request_id: std.atomic.Value(u64),
    
    pub fn init(allocator: std.mem.Allocator, endpoint: []const u8) RpcClient;
    pub fn getBalance(self: *RpcClient, pubkey: PublicKey) !u64;
    pub fn getLatestBlockhash(self: *RpcClient) !struct { hash: Hash, lastValidBlockHeight: u64 };
    pub fn getAccountInfo(self: *RpcClient, pubkey: PublicKey) !?AccountInfo;
    pub fn sendTransaction(self: *RpcClient, tx: []const u8) !Signature;
    pub fn getSignatureStatuses(self: *RpcClient, sigs: []const Signature) ![]?TransactionStatus;
};
```

### 错误处理

```zig
pub const ClientError = error{
    HttpError,
    JsonParseError,
    RpcError,
    Timeout,
    ConnectionFailed,
};

pub const RpcError = struct {
    code: i64,
    message: []const u8,
    data: ?[]const u8,
};
```

## 实现顺序

```
1. client/build.zig, build.zig.zon     (项目结构)
2. client/src/error.zig                (错误类型)
3. client/src/config.zig               (配置类型)
4. client/src/json_rpc.zig             (JSON-RPC 协议)
5. client/src/rpc_client.zig           (RPC 方法)
   - getBalance (最简单，验证整体流程)
   - getLatestBlockhash (交易必需)
   - getAccountInfo (查询账户)
   - sendTransaction (发送交易)
   - getSignatureStatuses (确认交易)
6. client/src/signer.zig               (交易签名)
7. client/src/root.zig                 (导出)
```

## 测试策略

### 单元测试
- JSON-RPC 序列化/反序列化
- 错误处理
- 配置解析

### 集成测试（可选）
- 使用 Solana devnet/testnet
- 或使用 mock HTTP server

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| HTTP Client 兼容性 | std.http 在不同平台行为不同 | 充分测试 Linux/macOS |
| JSON 解析性能 | 大响应可能较慢 | 使用流式解析 |
| 网络错误处理 | 超时、重试逻辑复杂 | 先实现简单版本 |

## 完成状态

- 开始日期: 2026-01-06
- 完成日期: -
- 当前状态: ⏳ 规划中
