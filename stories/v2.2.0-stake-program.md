# Story: v2.2.0 SPL Stake Program Interface

> 实现 Solana 核心 Stake 程序接口，用于质押操作和验证者委托。

## 目标

实现 Stake 程序的客户端接口：

**Program ID**: `Stake11111111111111111111111111111111111111`

**Source**: https://github.com/solana-program/stake

### 特点

- Solana 核心原生程序
- 状态机设计 (Uninitialized → Initialized → Stake)
- 支持验证者委托和奖励分配
- 17 个活跃指令

## 验收标准

### spl/stake/state.zig

- [x] 常量定义
  - [x] `STAKE_PROGRAM_ID` - Program ID
  - [x] Size constants for all data structures

- [x] `StakeStateV2` 枚举 (~200 bytes)
  - [x] `Uninitialized`
  - [x] `Initialized` - Meta only
  - [x] `Stake` - Meta + Stake
  - [x] `RewardsPool` (deprecated)
  - [x] `pack()` / `unpack()` 方法

- [x] `Meta` 结构体 (~120 bytes)
  - [x] `rent_exempt_reserve: u64`
  - [x] `authorized: Authorized`
  - [x] `lockup: Lockup`

- [x] `Authorized` 结构体 (64 bytes)
  - [x] `staker: PublicKey`
  - [x] `withdrawer: PublicKey`

- [x] `Lockup` 结构体 (48 bytes)
  - [x] `unix_timestamp: i64`
  - [x] `epoch: u64`
  - [x] `custodian: PublicKey`

- [x] `Stake` 结构体 (~72 bytes)
  - [x] `delegation: Delegation`
  - [x] `credits_observed: u64`

- [x] `Delegation` 结构体 (64 bytes)
  - [x] `voter_pubkey: PublicKey`
  - [x] `stake: u64`
  - [x] `activation_epoch: u64`
  - [x] `deactivation_epoch: u64`

- [x] `StakeFlags` 结构体 (1 byte)
  - [x] `must_fully_activate_before_deactivation_is_permitted` flag
  - [x] `isEmpty()`, `toByte()`, `fromByte()` methods

- [x] 常量和函数
  - [x] `DEFAULT_WARMUP_COOLDOWN_RATE` - 0.25
  - [x] `NEW_WARMUP_COOLDOWN_RATE` - 0.09
  - [x] `DEFAULT_SLASH_PENALTY` - 5%
  - [x] `MINIMUM_DELINQUENT_EPOCHS_FOR_DEACTIVATION` - 5
  - [x] `warmupCooldownRate()` - 获取预热/冷却速率

- [x] `Delegation` 方法
  - [x] `isBootstrap()` - 检查是否为引导质押
  - [x] `getStake()` - 获取有效质押
  - [x] `stakeActivatingAndDeactivating()` - 计算激活/停用状态
  - [x] `calculateActivatingStake()` - 计算激活中的质押
  - [x] `calculateDeactivatingStake()` - 计算停用中的质押

- [x] `Stake` 方法
  - [x] `getStake()` - 获取有效质押
  - [x] `split()` - 分割质押账户

- [x] 单元测试 (34 tests)
  - [x] Pack/unpack roundtrip tests
  - [x] Size validation tests

### spl/stake/stake_history.zig (NEW)

- [x] `MAX_ENTRIES` - 最大条目数 (512)

- [x] `StakeHistoryEntry` 结构体 (24 bytes)
  - [x] `effective: u64` - 有效质押
  - [x] `activating: u64` - 激活中质押
  - [x] `deactivating: u64` - 停用中质押
  - [x] `withEffective()` 构造器
  - [x] `withEffectiveAndActivating()` 构造器
  - [x] `withDeactivating()` 构造器
  - [x] `add()` 方法
  - [x] `pack()` / `unpack()` 方法

- [x] `StakeHistory` 结构体
  - [x] `init()` / `deinit()` 方法
  - [x] `get()` - 获取指定 epoch 的条目
  - [x] `addEntry()` - 添加条目（自动排序，限制大小）
  - [x] `len()` / `isEmpty()` / `items()` 方法

- [x] `StakeHistoryGetEntry` trait (泛型接口)

- [x] 单元测试 (10 tests)
  - [x] Entry 构造器测试
  - [x] Pack/unpack roundtrip
  - [x] History 基本操作
  - [x] History 排序测试

### spl/stake/tools.zig (NEW)

- [x] `EpochCredits` 结构体
  - [x] `epoch: u64`
  - [x] `credits: u64`
  - [x] `prev_credits: u64`

- [x] `acceptableReferenceEpochCredits()` 函数
  - [x] 检查投票账户是否可作为 deactivate_delinquent 参考

- [x] `eligibleForDeactivateDelinquent()` 函数
  - [x] 检查投票账户是否符合停用资格

- [x] 单元测试 (5 tests)
  - [x] 常量测试
  - [x] acceptableReferenceEpochCredits 测试
  - [x] eligibleForDeactivateDelinquent 测试

### spl/stake/instruction.zig

- [x] `StakeInstruction` 枚举 (18 variants)
  - [x] Initialize = 0
  - [x] Authorize = 1
  - [x] DelegateStake = 2
  - [x] Split = 3
  - [x] Withdraw = 4
  - [x] Deactivate = 5
  - [x] SetLockup = 6
  - [x] Merge = 7
  - [x] AuthorizeWithSeed = 8
  - [x] InitializeChecked = 9
  - [x] AuthorizeChecked = 10
  - [x] AuthorizeCheckedWithSeed = 11
  - [x] SetLockupChecked = 12
  - [x] GetMinimumDelegation = 13
  - [x] DeactivateDelinquent = 14
  - [x] Redelegate = 15 (deprecated)
  - [x] MoveStake = 16
  - [x] MoveLamports = 17

- [x] `StakeAuthorize` 枚举
  - [x] Staker = 0
  - [x] Withdrawer = 1

- [x] 单元测试 (14 tests)
  - [x] Instruction discriminant tests
  - [x] Instruction builder tests

### spl/stake/error.zig

- [x] `StakeError` 枚举 (17 variants)
  - [x] NoCreditsToRedeem = 0
  - [x] LockupInForce = 1
  - [x] AlreadyDeactivated = 2
  - [x] TooSoonToRedelegate = 3
  - [x] InsufficientStake = 4
  - [x] MergeTransientStake = 5
  - [x] MergeMismatch = 6
  - [x] CustodianMissing = 7
  - [x] CustodianSignatureMissing = 8
  - [x] InsufficientReferenceVotes = 9
  - [x] VoteAddressMismatch = 10
  - [x] MinimumDelinquentEpochsForDeactivationNotMet = 11
  - [x] InsufficientDelegation = 12
  - [x] RedelegateTransientOrInactiveStake = 13
  - [x] RedelegateToSameVoteAccount = 14
  - [x] RedelegatedStakeMustFullyActivateBeforeDeactivationIsPermitted = 15
  - [x] EpochRewardsActive = 16

- [x] `toCode()` / `fromCode()` 方法
- [x] `message()` 错误描述
- [x] 单元测试 (5 tests)

### spl/stake/root.zig

- [x] 导出所有类型
- [x] 便捷重导出

### spl/root.zig

- [x] 导出 `stake` 模块
- [x] 添加 `STAKE_PROGRAM_ID` 便捷重导出

### client/src/spl/stake/instruction.zig

- [x] 指令构建器 (18 instructions)
  - [x] `initialize()` - 初始化质押账户
  - [x] `authorize()` - 更改授权
  - [x] `delegate()` - 委托质押
  - [x] `split()` - 分割质押
  - [x] `withdraw()` - 提取质押
  - [x] `deactivate()` - 停用质押
  - [x] `setLockup()` - 设置锁定期
  - [x] `merge()` - 合并质押
  - [x] `authorizeWithSeed()` - 使用种子授权
  - [x] `initializeChecked()` - 检查初始化
  - [x] `authorizeChecked()` - 检查授权
  - [x] `authorizeCheckedWithSeed()` - 使用种子检查授权
  - [x] `setLockupChecked()` - 检查设置锁定期
  - [x] `getMinimumDelegation()` - 获取最小委托
  - [x] `deactivateDelinquent()` - 停用违规质押
  - [x] `redelegate()` - 重新委托 (deprecated)
  - [x] `moveStake()` - 移动质押
  - [x] `moveLamports()` - 移动 lamports

- [x] 单元测试

### 集成

- [x] `root.zig` 导出
- [x] ROADMAP.md 更新
- [x] CHANGELOG.md 更新
- [x] 所有测试通过
  - [x] SDK: 253 tests
  - [x] Program SDK: 294 tests
  - [x] Client: 148 tests

## 技术细节

### Rust SDK 参考

```rust
// https://github.com/solana-program/stake/blob/master/interface/src/state.rs

/// Program ID
pub mod program {
    solana_pubkey::declare_id!("Stake11111111111111111111111111111111111111");
}

/// Stake state V2
pub enum StakeStateV2 {
    Uninitialized,
    Initialized(Meta),
    Stake(Meta, Stake, StakeFlags),
    RewardsPool,
}

/// Meta information about a stake account
pub struct Meta {
    pub rent_exempt_reserve: u64,
    pub authorized: Authorized,
    pub lockup: Lockup,
}

/// Authorized staker and withdrawer
pub struct Authorized {
    pub staker: Pubkey,
    pub withdrawer: Pubkey,
}

/// Lockup restrictions
pub struct Lockup {
    pub unix_timestamp: UnixTimestamp,
    pub epoch: Epoch,
    pub custodian: Pubkey,
}

/// Stake delegation information
pub struct Delegation {
    pub voter_pubkey: Pubkey,
    pub stake: u64,
    pub activation_epoch: Epoch,
    pub deactivation_epoch: Epoch,
}

/// Active stake with delegation and credits
pub struct Stake {
    pub delegation: Delegation,
    pub credits_observed: u64,
}
```

### 文件结构

```
sdk/src/spl/
├── root.zig              # SPL module exports
├── memo.zig              # Memo program (v2.3.0 ✅)
├── token/                # Token program (v2.0.0 ✅)
│   ├── root.zig
│   ├── state.zig
│   ├── instruction.zig
│   └── error.zig
└── stake/                # Stake program (v2.2.0) <- NEW
    ├── root.zig          # Stake module exports
    ├── state.zig         # StakeStateV2, Meta, Stake, Delegation
    ├── stake_history.zig # StakeHistory, StakeHistoryEntry (NEW)
    ├── tools.zig         # Delinquent detection utilities (NEW)
    ├── instruction.zig   # StakeInstruction enum
    └── error.zig         # StakeError enum

client/src/spl/
├── root.zig              # SPL client module exports
├── token/                # Token client
│   └── instruction.zig
└── stake/                # Stake client (NEW)
    ├── root.zig          # Stake client exports
    └── instruction.zig   # Instruction builders
```

## 依赖

- `sdk/src/public_key.zig` - PublicKey 类型
- `sdk/src/borsh.zig` - Borsh 序列化 (Stake 使用 Borsh)

## 完成状态

- 开始日期: 2026-01-07
- 完成日期: 2026-01-07
- 状态: ✅ 已完成
