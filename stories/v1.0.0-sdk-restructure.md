# Story: v1.0.0 SDK 架构重构

> 将单一仓库拆分为三层架构：共享 SDK、Program SDK、Client SDK

## 背景

当前 `solana-program-sdk-zig` 仓库包含所有模块（共享类型 + on-chain 功能）。这导致：
- Client 开发需要依赖不必要的 on-chain 模块（syscalls, entrypoint 等）
- 模块职责边界不清晰
- 难以独立发布和版本管理

## 目标架构

```
┌─────────────────────────────────────┐
│  solana-sdk-zig (共享核心类型)       │
│  ├── PublicKey, Hash, Signature     │
│  ├── Transaction, Message           │
│  ├── Instruction, AccountMeta       │
│  └── bincode, borsh, short_vec      │
└─────────────────────────────────────┘
          ▲                 ▲
          │                 │
          │ 依赖            │ 依赖
          │                 │
┌─────────────────┐  ┌─────────────────┐
│ program-sdk     │  │ client-sdk      │
│ ├── syscalls    │  │ ├── RPC Client  │
│ ├── entrypoint  │  │ ├── Connection  │
│ ├── CPI         │  │ └── Signer      │
│ └── sysvars     │  │                 │
└─────────────────┘  └─────────────────┘
```

## 模块分类

### solana-sdk-zig (共享核心类型)

**原则**: 无 syscall 依赖，可在任何环境运行

| 模块 | 说明 | 依赖 |
|------|------|------|
| `public_key.zig` | PublicKey 类型定义 | base58 |
| `hash.zig` | Hash 类型定义 | base58 |
| `signature.zig` | Signature 类型定义 | base58 |
| `keypair.zig` | Keypair 类型 (无签名功能) | public_key, signature |
| `account.zig` | Account 结构定义 | public_key |
| `instruction.zig` | Instruction, AccountMeta 定义 | public_key |
| `message.zig` | Message 结构定义 | public_key, hash, instruction |
| `transaction.zig` | Transaction 结构定义 | message, signature |
| `bincode.zig` | Bincode 序列化 | std |
| `borsh.zig` | Borsh 序列化 | std |
| `short_vec.zig` | ShortVec 编码 | std |
| `error.zig` | ProgramError 定义 | std |
| `nonce.zig` | Nonce 类型定义 | public_key, hash |
| `native_token.zig` | LAMPORTS_PER_SOL 等常量 | std |

**需要修改的模块**:
- `public_key.zig`: 移除 `createProgramAddress`/`findProgramAddress` 的 syscall 实现，保留纯计算版本
- `instruction.zig`: 移除 CPI 相关代码，仅保留类型定义

### solana-program-sdk-zig (On-chain 程序开发)

**原则**: 依赖 SDK，添加 syscall 和 BPF 特定功能

| 模块 | 说明 | 特性 |
|------|------|------|
| `syscalls.zig` | Syscall 定义 | BPF 特定 |
| `entrypoint.zig` | 程序入口 | BPF 特定 |
| `allocator.zig` | BPF 分配器 | BPF 特定 |
| `log.zig` | 日志 | syscall |
| `context.zig` | 入口解析 | BPF 特定 |
| `bpf.zig` | BPF 工具 | BPF 特定 |
| `program_memory.zig` | 内存操作 | syscall |
| `clock.zig` | Clock sysvar | syscall |
| `rent.zig` | Rent sysvar | syscall |
| `epoch_schedule.zig` | EpochSchedule sysvar | syscall |
| ... (其他 sysvars) | | syscall |
| `system_program.zig` | System Program 接口 | 依赖 SDK |
| `bpf_loader.zig` | BPF Loader 接口 | 依赖 SDK |
| ... (其他 native programs) | | |
| `bn254.zig` | BN254 加密 | syscall |
| `blake3.zig` | Blake3 哈希 | syscall |
| ... (其他 crypto) | | syscall |

### solana-client-sdk-zig (Client 开发)

**原则**: 依赖 SDK，添加 RPC 和交易构建功能

| 模块 | 说明 | 状态 |
|------|------|------|
| `rpc/client.zig` | JSON-RPC Client | ⏳ 待实现 |
| `rpc/types.zig` | RPC 类型定义 | ⏳ 待实现 |
| `connection.zig` | Connection API | ⏳ 待实现 |
| `transaction/builder.zig` | 交易构建器 | ⏳ 待实现 |
| `transaction/signer.zig` | 交易签名 | ⏳ 待实现 |
| `wallet/keypair.zig` | 完整 Keypair (含签名) | ⏳ 待实现 |

## 验收标准

### Phase 1: 创建 solana-sdk-zig ✅

- [x] 创建 `sdk/` 目录结构
- [x] 移动共享类型模块到 `sdk/src/`
- [x] 修改 `public_key.zig` 移除 syscall 依赖 (保留纯 SHA256 PDA 计算)
- [x] 修改 `instruction.zig` 移除 CPI 代码 (仅保留类型定义)
- [x] 创建 `sdk/build.zig` 和 `sdk/build.zig.zon`
- [x] 创建 `sdk/src/root.zig` 导出所有类型
- [x] `./solana-zig/zig build test` 在 sdk/ 目录通过 (105/105 tests)
- [x] 所有 SDK 模块无 syscall 依赖

### Phase 2: 重构 solana-program-sdk-zig ✅

- [x] 修改 `build.zig` 依赖 `sdk/`
- [x] 修改 `build.zig.zon` 添加 sdk 作为本地依赖
- [x] 保留 syscall 相关功能在 program 模块 (src/ 保持不变)
- [x] 为 `public_key` 提供 syscall 版本的 PDA 函数 (src/public_key.zig 保留原有实现)
- [x] `./solana-zig/zig build test` 通过 (375/375)
- [x] 功能行为与重构前一致
- [x] 导出 `solana_sdk` 模块供消费者选择使用

### Phase 3: 创建 solana-client-sdk-zig (后续)

- [ ] 创建 `client/` 目录结构
- [ ] 实现 RPC Client
- [ ] 实现 Connection API
- [ ] 实现交易构建器
- [ ] 添加测试

## 实现步骤

### Step 1: 文档准备 ✅
- [x] 创建本 Story 文件
- [x] 更新 ROADMAP.md
- [x] 创建设计文档 (模块依赖图) - `docs/design/module-dependency-graph.md`

### Step 2: Phase 1 实施 ✅
- [x] 验证当前测试通过 (375/375)
- [x] 创建 sdk/ 目录
- [x] 复制共享模块 (hash, signature, bincode, borsh, short_vec, error, native_token, keypair, nonce)
- [x] 修改移除 syscall 依赖 (public_key.zig, instruction.zig)
- [x] 测试 SDK 独立编译 (105/105 tests passed)
- [ ] 提交: "refactor: extract shared SDK types"

### Step 3: Phase 2 实施 ✅
- [x] 修改 build.zig 添加 SDK 依赖
- [x] 修改 build.zig.zon 添加本地路径依赖
- [x] 导出 solana_sdk 模块
- [x] 测试完整功能 (375/375 tests passed)
- [ ] 提交: "refactor: program-sdk depends on SDK"

### Step 4: Phase 3 实施 (后续)
- [ ] 创建 client 目录
- [ ] 实现 RPC client
- [ ] 测试
- [ ] 提交: "feat: add client SDK"

## 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 循环依赖 | 编译失败 | 仔细分析依赖图，先移动叶子模块 |
| API 变更 | 用户代码破坏 | 保持向后兼容，版本 1.0.0 |
| 测试覆盖不足 | 功能回归 | 每步都运行完整测试 |
| syscall 分离不完整 | SDK 无法独立使用 | 使用条件编译或完全分离 |

## 完成状态

- 开始日期: 2026-01-06
- 完成日期: 2026-01-06
- 当前状态: ✅ Phase 1 & 2 完成 (Phase 3 Client SDK 待后续实现)
