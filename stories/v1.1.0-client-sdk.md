# Story: v1.1.0 Client SDK 实现

> 实现完整的 Solana RPC Client SDK，覆盖所有 52 个 HTTP RPC 方法

## 背景

当前项目已完成：
- `sdk/` - 共享核心类型（无 syscall 依赖）
- `src/` - Program SDK（含 syscall，用于链上程序）

缺少 Client SDK，无法进行链下开发（构建交易、查询账户、提交交易等）。

## 目标

实现与 Rust `solana-rpc-client` 对等的功能：
- 52 个 HTTP RPC 方法
- `_with_commitment` 变体
- WebSocket 订阅（后续）

## RPC 方法完整列表 (52 个)

### Account Methods (7)

| 方法 | 说明 | 优先级 |
|------|------|--------|
| `getAccountInfo` | 查询账户信息 | P0 |
| `getBalance` | 查询余额 | P0 |
| `getMultipleAccounts` | 批量查询账户 | P1 |
| `getProgramAccounts` | 查询程序拥有的账户 | P1 |
| `getLargestAccounts` | 查询最大账户 | P2 |
| `getTokenAccountBalance` | SPL Token 余额 | P1 |
| `getTokenAccountsByOwner` | 按所有者查询 Token 账户 | P1 |

### Block Methods (10)

| 方法 | 说明 | 优先级 |
|------|------|--------|
| `getBlock` | 查询区块信息 | P1 |
| `getBlockHeight` | 当前区块高度 | P1 |
| `getBlockProduction` | 区块生产信息 | P2 |
| `getBlockCommitment` | 区块确认状态 | P2 |
| `getBlocks` | 查询区块列表 | P2 |
| `getBlocksWithLimit` | 带限制的区块列表 | P2 |
| `getBlockTime` | 区块时间 | P2 |
| `getFirstAvailableBlock` | 最早可用区块 | P2 |
| `getLatestBlockhash` | 最新区块哈希 | P0 |
| `isBlockhashValid` | 验证区块哈希有效性 | P1 |

### Transaction Methods (9)

| 方法 | 说明 | 优先级 |
|------|------|--------|
| `getTransaction` | 查询交易详情 | P1 |
| `getSignatureStatuses` | 查询签名状态 | P0 |
| `getSignaturesForAddress` | 按地址查询签名 | P1 |
| `getTransactionCount` | 交易计数 | P2 |
| `sendTransaction` | 发送交易 | P0 |
| `simulateTransaction` | 模拟交易 | P1 |
| `getFeeForMessage` | 消息费用 | P1 |
| `getRecentPrioritizationFees` | 优先费用 | P1 |
| `requestAirdrop` | 空投 (devnet) | P1 |

### Cluster & Node Methods (11)

| 方法 | 说明 | 优先级 |
|------|------|--------|
| `getClusterNodes` | 集群节点信息 | P2 |
| `getEpochInfo` | 当前 epoch 信息 | P1 |
| `getEpochSchedule` | epoch 调度 | P2 |
| `getGenesisHash` | 创世区块哈希 | P2 |
| `getHealth` | 节点健康状态 | P1 |
| `getHighestSnapshotSlot` | 最高快照 slot | P2 |
| `getIdentity` | 节点身份 | P2 |
| `getSlot` | 当前 slot | P1 |
| `getSlotLeader` | 当前 slot leader | P2 |
| `getSlotLeaders` | slot leaders 列表 | P2 |
| `getVersion` | Solana 版本 | P1 |

### Inflation & Economics (6)

| 方法 | 说明 | 优先级 |
|------|------|--------|
| `getInflationGovernor` | 通胀治理 | P2 |
| `getInflationRate` | 通胀率 | P2 |
| `getInflationReward` | 通胀奖励 | P2 |
| `getSupply` | 供应量信息 | P2 |
| `getMinimumBalanceForRentExemption` | 租金豁免最小余额 | P0 |
| `getStakeMinimumDelegation` | 最小质押委托 | P2 |

### Validator & Voting (3)

| 方法 | 说明 | 优先级 |
|------|------|--------|
| `getVoteAccounts` | 投票账户 | P2 |
| `getLeaderSchedule` | Leader 调度 | P2 |
| `getRecentPerformanceSamples` | 性能样本 | P2 |

### Token Methods (SPL) (4)

| 方法 | 说明 | 优先级 |
|------|------|--------|
| `getTokenSupply` | Token 供应量 | P1 |
| `getTokenLargestAccounts` | 最大 Token 账户 | P2 |
| `getTokenAccountsByDelegate` | 按委托查询 | P2 |

### Utility (2)

| 方法 | 说明 | 优先级 |
|------|------|--------|
| `minimumLedgerSlot` | 最小账本 slot | P2 |
| `getMaxRetransmitSlot` | 最大重传 slot | P2 |

## 实现阶段

### Phase 1: 基础设施

```
client/
├── build.zig
├── build.zig.zon
└── src/
    ├── root.zig
    ├── error.zig          # ClientError, RpcError
    ├── types.zig          # Response, Context, 配置类型
    ├── commitment.zig     # CommitmentConfig
    └── json_rpc.zig       # JSON-RPC 请求/响应处理
```

### Phase 2: P0 核心方法 (最小可用)

| 方法 | 用途 |
|------|------|
| `getBalance` | 查询余额 |
| `getAccountInfo` | 查询账户 |
| `getLatestBlockhash` | 交易构建必需 |
| `getMinimumBalanceForRentExemption` | 创建账户必需 |
| `sendTransaction` | 发送交易 |
| `getSignatureStatuses` | 确认交易 |

### Phase 3: P1 常用方法

| 方法 | 用途 |
|------|------|
| `getMultipleAccounts` | 批量查询 |
| `getProgramAccounts` | 查询程序账户 |
| `getTransaction` | 交易详情 |
| `simulateTransaction` | 模拟执行 |
| `requestAirdrop` | 开发测试 |
| `getTokenAccountBalance` | SPL Token |
| `getTokenAccountsByOwner` | SPL Token |
| `isBlockhashValid` | 区块哈希验证 |
| `getEpochInfo` | Epoch 信息 |
| `getSlot` | 当前 Slot |
| `getHealth` | 健康检查 |
| `getVersion` | 版本信息 |
| `getFeeForMessage` | 费用估算 |
| `getRecentPrioritizationFees` | 优先费用 |
| `getSignaturesForAddress` | 历史签名 |
| `getTokenSupply` | Token 供应量 |
| `getBlock` | 区块信息 |
| `getBlockHeight` | 区块高度 |

### Phase 4: P2 完整实现

剩余所有方法，确保 52 个全部覆盖。

### Phase 5: 便捷方法

- `_with_commitment` 变体
- `send_and_confirm_transaction` (发送并等待确认)
- `poll_for_signature` (轮询签名状态)
- `wait_for_balance` (等待余额变化)

### Phase 6: WebSocket 订阅 (可选)

- `accountSubscribe` / `accountUnsubscribe`
- `slotSubscribe` / `slotUnsubscribe`
- `signatureSubscribe` / `signatureUnsubscribe`
- 等 9 对订阅方法

## 验收标准

### Phase 1: 基础设施 ⏳
- [ ] 创建 `client/` 目录结构
- [ ] 实现 `error.zig` - ClientError, RpcError
- [ ] 实现 `types.zig` - Response<T>, RpcResponseContext
- [ ] 实现 `commitment.zig` - CommitmentConfig
- [ ] 实现 `json_rpc.zig` - HTTP JSON-RPC 客户端
- [ ] 基础测试通过

### Phase 2: P0 核心 ⏳
- [ ] `getBalance`
- [ ] `getAccountInfo`
- [ ] `getLatestBlockhash`
- [ ] `getMinimumBalanceForRentExemption`
- [ ] `sendTransaction`
- [ ] `getSignatureStatuses`
- [ ] 端到端测试 (devnet)

### Phase 3: P1 常用 ⏳
- [ ] 18 个 P1 方法全部实现
- [ ] 测试覆盖

### Phase 4: P2 完整 ⏳
- [ ] 剩余方法实现
- [ ] 52 个方法全部覆盖
- [ ] 完整测试

### Phase 5: 便捷方法 ⏳
- [ ] `_with_commitment` 变体
- [ ] 辅助方法 (send_and_confirm 等)

## 技术设计

### RpcClient 结构

```zig
pub const RpcClient = struct {
    allocator: std.mem.Allocator,
    endpoint: []const u8,
    commitment: CommitmentConfig,
    http_client: std.http.Client,
    request_id: std.atomic.Value(u64),

    // P0 Methods
    pub fn getBalance(self: *RpcClient, pubkey: PublicKey) !u64;
    pub fn getBalanceWithCommitment(self: *RpcClient, pubkey: PublicKey, commitment: Commitment) !Response(u64);
    pub fn getAccountInfo(self: *RpcClient, pubkey: PublicKey) !?AccountInfo;
    pub fn getLatestBlockhash(self: *RpcClient) !LatestBlockhash;
    pub fn getMinimumBalanceForRentExemption(self: *RpcClient, data_len: usize) !u64;
    pub fn sendTransaction(self: *RpcClient, transaction: []const u8) !Signature;
    pub fn getSignatureStatuses(self: *RpcClient, signatures: []const Signature) ![]?TransactionStatus;
    
    // ... 46 more methods
};
```

### Response 类型

```zig
pub fn Response(comptime T: type) type {
    return struct {
        context: RpcResponseContext,
        value: T,
    };
}

pub const RpcResponseContext = struct {
    slot: u64,
    api_version: ?[]const u8,
};
```

### 错误类型

```zig
pub const ClientError = error{
    HttpError,
    JsonParseError,
    RpcError,
    Timeout,
    ConnectionFailed,
    InvalidResponse,
};

pub const RpcErrorInfo = struct {
    code: i64,
    message: []const u8,
    data: ?std.json.Value,
};
```

## 方法统计

| 优先级 | 数量 | 说明 |
|--------|------|------|
| P0 | 6 | 最小可用 |
| P1 | 18 | 常用方法 |
| P2 | 28 | 完整覆盖 |
| **Total** | **52** | 全部 HTTP RPC |

## 完成状态

- 开始日期: 2026-01-06
- 完成日期: -
- 当前状态: ⏳ 规划中
