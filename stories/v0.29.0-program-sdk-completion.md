# Story: v0.29.0 Program SDK 补全

> 补全 Program SDK 缺失的关键模块，提升覆盖率至 ~90%

## 背景

根据 Solana SDK 官方仓库分析，当前 Program SDK 覆盖率约 79%。本版本重点补全以下缺失模块：

1. **loader-v3 指令** - 可升级 BPF Loader 的完整指令集
2. **instruction_error** - 运行时指令错误类型
3. **transaction_error** - 交易错误类型（Client SDK 预备）
4. **epoch_info** - Epoch 信息类型（Client SDK 预备）
5. **sdk_ids** - 程序 ID 常量集合

## 模块分析

### loader-v3-interface (扩展 bpf_loader.zig)

**Rust 源码**: https://github.com/anza-xyz/solana-sdk/blob/master/loader-v3-interface/src/instruction.rs

当前 `bpf_loader.zig` 只有 ID 和状态类型，缺少指令构建器：

| 指令 | 说明 | 状态 |
|------|------|------|
| `InitializeBuffer` | 初始化 Buffer 账户 | ✅ |
| `Write` | 写入程序数据到 Buffer | ✅ |
| `DeployWithMaxDataLen` | 部署可升级程序 | ✅ |
| `Upgrade` | 升级程序 | ✅ |
| `SetAuthority` | 设置权限 | ✅ |
| `Close` | 关闭账户 | ✅ |
| `ExtendProgram` | 扩展程序数据 | ✅ |
| `SetAuthorityChecked` | 设置权限（需签名） | ✅ |
| `Migrate` | 迁移到 loader-v4 | ✅ |
| `ExtendProgramChecked` | 扩展程序（需签名） | ✅ |

### instruction_error.zig

**Rust 源码**: https://github.com/anza-xyz/solana-sdk/blob/master/instruction-error/src/lib.rs

运行时返回的指令错误，比 `ProgramError` 更详细（约 50 个错误类型）。

**关键差异**:
- `ProgramError` - 程序返回给运行时的错误
- `InstructionError` - 运行时返回给客户端的错误

### transaction_error.zig

**Rust 源码**: https://github.com/anza-xyz/solana-sdk/blob/master/transaction-error/src/lib.rs

交易级别错误（约 35 个错误类型）。主要用于 Client SDK。

### epoch_info.zig

**Rust 源码**: https://github.com/anza-xyz/solana-sdk/blob/master/epoch-info/src/lib.rs

简单的结构体，RPC `getEpochInfo` 返回值。

```zig
pub const EpochInfo = struct {
    epoch: u64,
    slot_index: u64,
    slots_in_epoch: u64,
    absolute_slot: u64,
    block_height: u64,
    transaction_count: ?u64,
};
```

### sdk_ids.zig

**Rust 源码**: https://github.com/anza-xyz/solana-sdk/blob/master/sdk-ids/src/lib.rs

集中定义所有程序 ID 常量。当前分散在各模块中。

## 验收标准

### Phase 1: loader-v3 指令 (P1) ✅

- [x] 添加 `UpgradeableLoaderInstruction` 枚举到 `bpf_loader.zig`
- [x] 实现指令序列化 (`serialize()` 方法)
- [x] 实现指令类型检查函数 (`isUpgradeInstruction` 等)
- [x] 实现 `sizeOfBuffer/sizeOfProgramData/sizeOfProgram` 辅助函数
- [x] 添加单元测试 (15 新测试)

注: 完整的指令构建器（如 `createBuffer`, `deployWithMaxDataLen` 等）将在 Client SDK 阶段实现，因为它们需要创建完整的 Instruction 和 AccountMeta 列表。

### Phase 2: instruction_error.zig (P1) ✅

- [x] 创建 `sdk/src/instruction_error.zig`
- [x] 实现 `InstructionError` 枚举（~50 个错误）
- [x] 实现 `LamportsError` 枚举
- [x] 实现与 `ProgramError` 的转换
- [x] 添加 `toString()` 方法
- [x] 添加单元测试
- [x] 更新 `sdk/src/root.zig` 导出

### Phase 3: transaction_error.zig (P2 - Client SDK 预备) ✅

- [x] 创建 `sdk/src/transaction_error.zig`
- [x] 实现 `TransactionError` 枚举（~35 个错误）
- [x] 实现 `AddressLoaderError` 枚举
- [x] 实现 `SanitizeMessageError` 枚举
- [x] 添加 `toString()` 方法
- [x] 添加单元测试
- [x] 更新 `sdk/src/root.zig` 导出

### Phase 4: epoch_info.zig (P2 - Client SDK 预备) ✅

- [x] 创建 `sdk/src/epoch_info.zig`
- [x] 实现 `EpochInfo` 结构体
- [x] 添加 JSON 序列化支持
- [x] 添加单元测试
- [x] 更新 `sdk/src/root.zig` 导出

### Phase 5: sdk_ids.zig (P2 - 延后) ✅

> 注: 程序 ID 常量已分散在各模块中（bpf_loader.zig, system_program.zig 等），
> 暂不需要集中。如有需要，可在后续版本添加。

- [x] ~~创建 `sdk/src/sdk_ids.zig`~~ (Deferred - IDs already well-organized in respective modules)
- [x] ~~集中定义所有程序 ID 常量~~ (Deferred - not needed, current organization is clear)
- [x] ~~分类组织~~ (Deferred - already organized by module: system_program, bpf_loader, etc.)

### Phase 6: 文档更新 ✅

- [x] 更新 ROADMAP.md
- [x] 更新 CHANGELOG.md
- [x] 更新 README.md（如需要）

## 实现步骤

### Step 1: 文档准备 ✅
- [x] 创建本 Story 文件
- [x] 更新 ROADMAP.md

### Step 2: Phase 1 实施 ✅
- [x] 扩展 `bpf_loader.zig`
- [x] 运行测试验证
- [x] 提交: "feat(bpf_loader): add loader-v3 instruction builders"

### Step 3: Phase 2 实施 ✅
- [x] 创建 `instruction_error.zig`
- [x] 运行测试验证 (SDK: 105→111 tests)
- [x] 提交: "feat(sdk): add InstructionError type"

### Step 4: Phase 3-5 实施 ✅
- [x] 创建 `transaction_error.zig` (10 tests)
- [x] 创建 `epoch_info.zig` (11 tests)
- [x] 扩展 `bpf_loader.zig` with instructions (15 tests)
- [x] 运行测试验证: SDK 132 tests, Program SDK 300 tests

### Step 5: 文档收尾 ✅
- [x] 更新 ROADMAP.md 状态
- [x] 更新 CHANGELOG.md
- [x] 提交所有更改

## 模块放置决策

| 模块 | 放置位置 | 原因 |
|------|----------|------|
| `bpf_loader.zig` 扩展 | `src/` | 需要 SDK 类型用于指令构建 |
| `instruction_error.zig` | `sdk/src/` | 纯类型，无 syscall 依赖 |
| `transaction_error.zig` | `sdk/src/` | 纯类型，无 syscall 依赖 |
| `epoch_info.zig` | `sdk/src/` | 纯类型，RPC 返回值 |
| `sdk_ids.zig` | `sdk/src/` | 纯常量，无依赖 |

## 测试计划

```bash
# SDK 测试
cd sdk && ../solana-zig/zig build test --summary all

# Program SDK 测试
./solana-zig/zig build test --summary all

# 实际测试数量
# SDK: 105 -> 132 (+27 新测试)
# Program SDK: 285 -> 300 (+15 新测试)
```

## 实现摘要

| 模块 | 测试数 | 状态 |
|------|--------|------|
| `instruction_error.zig` | 6 | ✅ |
| `transaction_error.zig` | 10 | ✅ |
| `epoch_info.zig` | 11 | ✅ |
| `bpf_loader.zig` 扩展 | 15 | ✅ |
| **总计** | **42** | ✅ |

## 完成状态

- 开始日期: 2026-01-06
- 完成日期: 2026-01-06
- 当前状态: ✅ 已完成 (等待 commit)
