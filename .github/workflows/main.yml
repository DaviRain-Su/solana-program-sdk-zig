name: CI

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [dev, main]

env:
  SOLANA_ZIG_VERSION: v1.52.0

jobs:
  # Format check - fast, runs first
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache solana-zig
        uses: actions/cache@v4
        with:
          path: solana-zig
          key: solana-zig-${{ env.SOLANA_ZIG_VERSION }}-linux

      - name: Install solana-zig
        run: ./install-solana-zig.sh solana-zig

      - name: Check SDK format
        run: ./solana-zig/zig fmt --check sdk/src/

      - name: Check Program SDK format
        run: ./solana-zig/zig fmt --check src/

  # SDK tests - pure Zig, no syscalls
  sdk-test:
    name: SDK Tests
    needs: format
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache solana-zig
        uses: actions/cache@v4
        with:
          path: solana-zig
          key: solana-zig-${{ env.SOLANA_ZIG_VERSION }}-${{ runner.os }}

      - name: Install solana-zig
        shell: bash
        run: ./install-solana-zig.sh solana-zig

      - name: Test SDK
        shell: bash
        working-directory: sdk
        run: ../solana-zig/zig build test --summary all

  # Program SDK tests - includes syscall stubs
  program-test:
    name: Program SDK Tests
    needs: format
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Cache solana-zig
        uses: actions/cache@v4
        with:
          path: solana-zig
          key: solana-zig-${{ env.SOLANA_ZIG_VERSION }}-${{ runner.os }}

      - name: Install solana-zig
        shell: bash
        run: ./install-solana-zig.sh solana-zig

      - name: Test Program SDK
        shell: bash
        run: ./solana-zig/zig build test --summary all

  # Integration tests - build actual programs and test with Rust
  integration-test:
    name: Integration Tests
    needs: [sdk-test, program-test]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache solana-zig
        uses: actions/cache@v4
        with:
          path: solana-zig
          key: solana-zig-${{ env.SOLANA_ZIG_VERSION }}-${{ runner.os }}

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            program-test/target
          key: cargo-${{ runner.os }}-${{ hashFiles('program-test/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-

      - name: Install solana-zig
        shell: bash
        run: ./install-solana-zig.sh solana-zig

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.86.0

      # Windows OpenSSL workaround
      - name: Set Perl environment variables (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "PERL=$((where.exe perl)[0])" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          echo "OPENSSL_SRC_PERL=$((where.exe perl)[0])" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Install build deps
        shell: bash
        run: ./program-test/install-build-deps.sh

      - name: Build and test programs
        shell: bash
        run: ./program-test/test.sh

  # Build check for Solana target
  build-solana:
    name: Build for Solana
    needs: format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache solana-zig
        uses: actions/cache@v4
        with:
          path: solana-zig
          key: solana-zig-${{ env.SOLANA_ZIG_VERSION }}-linux

      - name: Install solana-zig
        run: ./install-solana-zig.sh solana-zig

      - name: Build for Solana SBF target
        run: ./solana-zig/zig build -Dtarget=sbf-solana --summary all
