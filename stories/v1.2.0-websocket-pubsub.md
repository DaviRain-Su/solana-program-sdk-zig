# Story: v1.2.0 WebSocket PubSub Client

> 实现 Solana WebSocket 订阅客户端，支持实时账户、交易、日志等事件订阅。

## 目标

实现完整的 WebSocket PubSub 客户端，支持 Solana 官方的 9 种订阅方法。

## 验收标准

### client/src/pubsub/types.zig

- [x] SlotInfo 类型 - 槽位信息
- [x] UiAccount 类型 - 账户 UI 表示
- [x] RpcLogsResponse 类型 - 日志响应
- [x] RpcSignatureResult 类型 - 签名结果
- [x] RpcBlockUpdate 类型 - 区块更新
- [x] RpcVote 类型 - 投票信息
- [x] SlotUpdate 类型 - 槽位更新
- [x] Context 类型 - 响应上下文
- [x] 单元测试

### client/src/pubsub/pubsub_client.zig

- [x] PubsubClient 结构体
- [x] WebSocket 连接管理
- [x] JSON-RPC 2.0 协议支持
- [x] accountSubscribe / accountUnsubscribe
- [x] blockSubscribe / blockUnsubscribe
- [x] logsSubscribe / logsUnsubscribe
- [x] programSubscribe / programUnsubscribe
- [x] rootSubscribe / rootUnsubscribe
- [x] signatureSubscribe / signatureUnsubscribe
- [x] slotSubscribe / slotUnsubscribe
- [x] slotsUpdatesSubscribe / sloatesUpdatesUnsubscribe
- [x] voteSubscribe / voteUnsubscribe
- [x] receiveNotification 方法
- [x] 单元测试

### client/src/pubsub/root.zig

- [x] 模块导出

### 集成

- [x] client/build.zig 添加 websocket 依赖
- [x] client/build.zig.zon 添加 websocket.zig 包
- [x] client/src/root.zig 导出 pubsub 模块
- [x] 所有测试通过

## 技术细节

### WebSocket 库

使用 karlseguin/websocket.zig：
- TLS 1.3 支持
- 纯 Zig 实现
- 轻量级，无外部依赖

### 订阅方法映射

| Solana RPC 方法 | Zig 方法 | 通知类型 |
|-----------------|----------|----------|
| accountSubscribe | subscribe(.account, ...) | AccountNotification |
| blockSubscribe | subscribe(.block, ...) | BlockNotification |
| logsSubscribe | subscribe(.logs, ...) | LogsNotification |
| programSubscribe | subscribe(.program, ...) | ProgramNotification |
| rootSubscribe | subscribe(.root, ...) | RootNotification |
| signatureSubscribe | subscribe(.signature, ...) | SignatureNotification |
| slotSubscribe | subscribe(.slot, ...) | SlotNotification |
| slotsUpdatesSubscribe | subscribe(.slots_updates, ...) | SlotsUpdatesNotification |
| voteSubscribe | subscribe(.vote, ...) | VoteNotification |

### 使用示例

```zig
const pubsub = @import("solana-client").pubsub;

// 连接 WebSocket
var client = try pubsub.PubsubClient.connect(allocator, "ws://localhost:8900");
defer client.deinit();

// 订阅槽位更新
const sub_id = try client.slotSubscribe();

// 接收通知
while (true) {
    const notification = try client.receiveNotification();
    switch (notification) {
        .slot => |slot_info| {
            std.debug.print("Slot: {d}\n", .{slot_info.slot});
        },
        else => {},
    }
}

// 取消订阅
try client.slotUnsubscribe(sub_id);
```

## 完成状态

- 开始日期: 2026-01-07
- 完成日期: 2026-01-07
- 状态: ✅ 已完成

## 测试结果

- Client SDK 测试: 102 passed (含 11 个 PubSub 测试)
- WebSocket 连接测试: passed
- JSON-RPC 序列化测试: passed
