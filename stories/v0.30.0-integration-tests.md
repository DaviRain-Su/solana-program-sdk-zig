# Story: v0.30.0 Rust-Zig é›†æˆæµ‹è¯•

> ä½¿ç”¨å®˜æ–¹ Rust SDK ç”Ÿæˆæµ‹è¯•å‘é‡ï¼ŒéªŒè¯ Zig SDK å®ç°çš„å…¼å®¹æ€§å’Œæ­£ç¡®æ€§

## èƒŒæ™¯

å½“å‰ Zig SDK çš„å•å…ƒæµ‹è¯•éƒ½æ˜¯ç‹¬ç«‹ç¼–å†™çš„ï¼Œç¼ºå°‘ä¸å®˜æ–¹ Rust SDK çš„äº¤å‰éªŒè¯ã€‚ä¸ºç¡®ä¿ Zig å®ç°ä¸ Rust å®ç°å®Œå…¨å…¼å®¹ï¼Œéœ€è¦ï¼š

1. ä½¿ç”¨ Rust SDK ç”Ÿæˆåºåˆ—åŒ–çš„æµ‹è¯•å‘é‡
2. Zig SDK ååºåˆ—åŒ–å¹¶éªŒè¯ç»“æœ
3. ç¡®ä¿ä¸¤ç«¯çš„æ•°æ®æ ¼å¼å®Œå…¨ä¸€è‡´

## æµ‹è¯•æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Rust Test Vector Generator                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ä½¿ç”¨å®˜æ–¹ solana-sdk crates ç”Ÿæˆ:                     â”‚   â”‚
â”‚  â”‚  - bincode åºåˆ—åŒ–æ•°æ®                                 â”‚   â”‚
â”‚  â”‚  - borsh åºåˆ—åŒ–æ•°æ®                                   â”‚   â”‚
â”‚  â”‚  - JSON æ ¼å¼æ•°æ®                                      â”‚   â”‚
â”‚  â”‚  - Base58 ç¼–ç å­—ç¬¦ä¸²                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚              test-vectors/ (ç”Ÿæˆçš„æµ‹è¯•æ•°æ®)                   â”‚
â”‚              â”œâ”€â”€ bincode/                                    â”‚
â”‚              â”‚   â”œâ”€â”€ instruction_error.bin                   â”‚
â”‚              â”‚   â”œâ”€â”€ transaction_error.bin                   â”‚
â”‚              â”‚   â””â”€â”€ loader_instruction.bin                  â”‚
â”‚              â”œâ”€â”€ json/                                       â”‚
â”‚              â”‚   â”œâ”€â”€ epoch_info.json                         â”‚
â”‚              â”‚   â””â”€â”€ pubkey.json                             â”‚
â”‚              â””â”€â”€ base58/                                     â”‚
â”‚                  â”œâ”€â”€ pubkeys.txt                             â”‚
â”‚                  â””â”€â”€ signatures.txt                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Zig Integration Tests                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  è¯»å– Rust ç”Ÿæˆçš„æµ‹è¯•å‘é‡:                            â”‚   â”‚
â”‚  â”‚  - ååºåˆ—åŒ– bincode æ•°æ®                              â”‚   â”‚
â”‚  â”‚  - è§£æ JSON æ•°æ®                                     â”‚   â”‚
â”‚  â”‚  - éªŒè¯ Base58 ç¼–è§£ç                                  â”‚   â”‚
â”‚  â”‚  - æ¯”å¯¹ç»“æœä¸é¢„æœŸå€¼                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æµ‹è¯•èŒƒå›´

### Phase 1: æ ¸å¿ƒç±»å‹å…¼å®¹æ€§ (P0)

| æµ‹è¯•é¡¹ | Rust Crate | Zig Module | éªŒè¯å†…å®¹ |
|--------|------------|------------|----------|
| PublicKey | `solana-pubkey` | `public_key.zig` | Base58 ç¼–è§£ç ã€å­—èŠ‚åºåˆ— |
| Hash | `solana-hash` | `hash.zig` | åå…­è¿›åˆ¶ç¼–è§£ç ã€SHA256 |
| Signature | `solana-signature` | `signature.zig` | Base58 ç¼–è§£ç ã€éªŒè¯ |
| Keypair | `solana-keypair` | `keypair.zig` | ç­¾åç”Ÿæˆã€éªŒè¯ |

### Phase 2: åºåˆ—åŒ–å…¼å®¹æ€§ (P0)

| æµ‹è¯•é¡¹ | åºåˆ—åŒ–æ ¼å¼ | éªŒè¯å†…å®¹ |
|--------|-----------|----------|
| InstructionError | bincode | æ‰€æœ‰ ~50 ç§é”™è¯¯å˜ä½“ |
| TransactionError | bincode | æ‰€æœ‰ ~35 ç§é”™è¯¯å˜ä½“ |
| UpgradeableLoaderInstruction | bincode | æ‰€æœ‰ 10 ç§æŒ‡ä»¤ç±»å‹ |
| AccountMeta | bincode | è´¦æˆ·å…ƒæ•°æ®åºåˆ—åŒ– |
| CompiledInstruction | bincode | ç¼–è¯‘åæŒ‡ä»¤æ ¼å¼ |

### Phase 3: JSON å…¼å®¹æ€§ (P1)

| æµ‹è¯•é¡¹ | éªŒè¯å†…å®¹ |
|--------|----------|
| EpochInfo | camelCase å­—æ®µåã€å¯é€‰å­—æ®µå¤„ç† |
| RPC å“åº”æ ¼å¼ | ä¸º Client SDK åšå‡†å¤‡ |

### Phase 4: PDA æ´¾ç”Ÿå…¼å®¹æ€§ (P0)

| æµ‹è¯•é¡¹ | éªŒè¯å†…å®¹ |
|--------|----------|
| findProgramAddress | å¤šç§ seeds ç»„åˆ |
| createProgramAddress | è¾¹ç•Œæ¡ä»¶æµ‹è¯• |
| getProgramDataAddress | BPF Loader åœ°å€æ´¾ç”Ÿ |

## å®ç°è®¡åˆ’

### Step 1: ç›®å½•ç»“æ„

```
program-test/
â”œâ”€â”€ Cargo.toml                    # æ·»åŠ æ–°ä¾èµ–
â”œâ”€â”€ src/
â”‚   â””â”€â”€ lib.rs                    # Rust æµ‹è¯•å‘é‡ç”Ÿæˆåº“
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ pubkey.rs                 # ç°æœ‰æµ‹è¯•
â”‚   â””â”€â”€ generate_vectors.rs       # æµ‹è¯•å‘é‡ç”Ÿæˆ
â”œâ”€â”€ test-vectors/                 # ç”Ÿæˆçš„æµ‹è¯•æ•°æ® (gitignore)
â”‚   â”œâ”€â”€ bincode/
â”‚   â”œâ”€â”€ json/
â”‚   â””â”€â”€ base58/
â”œâ”€â”€ integration/                  # Zig é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ build.zig
â”‚   â”œâ”€â”€ test_bincode.zig
â”‚   â”œâ”€â”€ test_json.zig
â”‚   â””â”€â”€ test_pubkey.zig
â””â”€â”€ test.sh                       # æ›´æ–°æµ‹è¯•è„šæœ¬
```

### Step 2: Rust ä¾èµ–æ›´æ–°

```toml
# Cargo.toml æ–°å¢ä¾èµ–
[dependencies]
solana-instruction-error = "3.0"
solana-transaction-error = "3.0"
solana-loader-v3-interface = "3.0"
solana-epoch-info = "3.0"
solana-hash = "3.0"
solana-signature = "3.0"
solana-keypair = "3.0"
bincode = "1.3"
serde_json = "1.0"
```

### Step 3: Rust æµ‹è¯•å‘é‡ç”Ÿæˆå™¨

```rust
// src/lib.rs
use std::fs;
use std::path::Path;

pub fn generate_instruction_error_vectors(output_dir: &Path) {
    use solana_instruction_error::InstructionError;
    
    let errors = vec![
        InstructionError::GenericError,
        InstructionError::InvalidArgument,
        InstructionError::InvalidInstructionData,
        InstructionError::Custom(42),
        // ... æ‰€æœ‰å˜ä½“
    ];
    
    for (i, err) in errors.iter().enumerate() {
        let bytes = bincode::serialize(err).unwrap();
        let filename = output_dir.join(format!("instruction_error_{}.bin", i));
        fs::write(filename, bytes).unwrap();
    }
}

pub fn generate_pubkey_vectors(output_dir: &Path) {
    use solana_pubkey::Pubkey;
    
    let pubkeys = vec![
        Pubkey::default(),
        Pubkey::new_unique(),
        // ç³»ç»Ÿç¨‹åºã€BPF Loader ç­‰å·²çŸ¥ ID
    ];
    
    // ç”Ÿæˆ Base58 å’Œå­—èŠ‚æ ¼å¼
}
```

### Step 4: Zig é›†æˆæµ‹è¯•

```zig
// integration/test_bincode.zig
const std = @import("std");
const sdk = @import("solana_sdk");

test "instruction_error: bincode compatibility with Rust" {
    const allocator = std.testing.allocator;
    
    // è¯»å– Rust ç”Ÿæˆçš„æµ‹è¯•å‘é‡
    const test_cases = [_]struct {
        file: []const u8,
        expected: sdk.InstructionError,
    }{
        .{ .file = "test-vectors/bincode/instruction_error_0.bin", .expected = .GenericError },
        .{ .file = "test-vectors/bincode/instruction_error_1.bin", .expected = .InvalidArgument },
        // ...
    };
    
    for (test_cases) |tc| {
        const data = try std.fs.cwd().readFileAlloc(allocator, tc.file, 1024);
        defer allocator.free(data);
        
        const parsed = try sdk.bincode.deserialize(sdk.InstructionError, data);
        try std.testing.expectEqual(tc.expected, parsed);
    }
}
```

### Step 5: æµ‹è¯•è„šæœ¬æ›´æ–°

```bash
#!/usr/bin/env bash
# test.sh

set -e

# 1. ç”Ÿæˆ Rust æµ‹è¯•å‘é‡
cargo run --manifest-path Cargo.toml --bin generate-vectors

# 2. è¿è¡Œ Rust å•å…ƒæµ‹è¯•
cargo test

# 3. æ„å»º Zig ç¨‹åº
$ZIG build --summary all

# 4. è¿è¡Œ Zig é›†æˆæµ‹è¯•
$ZIG build test-integration --summary all
```

## éªŒæ”¶æ ‡å‡†

### å¿…é¡»é€šè¿‡

- [x] PublicKey Base58 ç¼–è§£ç ä¸ Rust å®Œå…¨ä¸€è‡´
- [x] Hash Base58 ç¼–è§£ç ä¸ Rust å®Œå…¨ä¸€è‡´
- [x] Signature Base58 ç¼–è§£ç ä¸ Rust å®Œå…¨ä¸€è‡´
- [ ] InstructionError bincode åºåˆ—åŒ–ä¸ Rust å®Œå…¨ä¸€è‡´ (Rust ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜)
- [ ] TransactionError bincode åºåˆ—åŒ–ä¸ Rust å®Œå…¨ä¸€è‡´ (Rust ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜)
- [ ] UpgradeableLoaderInstruction bincode åºåˆ—åŒ–ä¸ Rust å®Œå…¨ä¸€è‡´
- [x] PDA æ´¾ç”Ÿç»“æœä¸ Rust å®Œå…¨ä¸€è‡´
- [ ] EpochInfo JSON æ ¼å¼ä¸ RPC å“åº”ä¸€è‡´

### æµ‹è¯•è¦†ç›–

- [ ] æ¯ç§ InstructionError å˜ä½“ (çº¦ 50 ä¸ª) - å·²ç”Ÿæˆæµ‹è¯•å‘é‡
- [ ] æ¯ç§ TransactionError å˜ä½“ (çº¦ 35 ä¸ª) - å·²ç”Ÿæˆæµ‹è¯•å‘é‡
- [ ] æ¯ç§ UpgradeableLoaderInstruction å˜ä½“ (10 ä¸ª) - å·²ç”Ÿæˆæµ‹è¯•å‘é‡
- [x] è¾¹ç•Œæ¡ä»¶å’Œç‰¹æ®Šå€¼æµ‹è¯• (PublicKey/Hash)

## é¢„æœŸæ”¶ç›Š

1. **å…¼å®¹æ€§ä¿è¯**: ç¡®ä¿ Zig SDK ä¸ Rust SDK å®Œå…¨å…¼å®¹
2. **å›å½’æµ‹è¯•**: é˜²æ­¢åç»­ä¿®æ”¹ç ´åå…¼å®¹æ€§
3. **æ–‡æ¡£ä»·å€¼**: æµ‹è¯•å‘é‡æœ¬èº«æ˜¯å¾ˆå¥½çš„æ ¼å¼æ–‡æ¡£
4. **Client SDK åŸºç¡€**: ä¸º v1.1.0 Client SDK æ‰“ä¸‹åŸºç¡€

## é£é™©ä¸æŒ‘æˆ˜

1. **Rust SDK ç‰ˆæœ¬æ›´æ–°**: éœ€è¦è·Ÿè¸ª Rust SDK ç‰ˆæœ¬å˜åŒ–
2. **bincode ç‰ˆæœ¬å·®å¼‚**: Rust bincode æœ‰å¤šä¸ªç‰ˆæœ¬ï¼Œéœ€ç¡®è®¤ç‰ˆæœ¬
3. **æµ‹è¯•å‘é‡ç»´æŠ¤**: éœ€è¦åœ¨ Rust SDK æ›´æ–°æ—¶é‡æ–°ç”Ÿæˆ

## æ—¶é—´ä¼°è®¡

| é˜¶æ®µ | ä¼°è®¡æ—¶é—´ |
|------|----------|
| Phase 1: æ ¸å¿ƒç±»å‹ | 2-3 å¤© |
| Phase 2: åºåˆ—åŒ– | 3-4 å¤© |
| Phase 3: JSON | 1-2 å¤© |
| Phase 4: PDA | 1-2 å¤© |
| **æ€»è®¡** | **7-11 å¤©** |

## å®ŒæˆçŠ¶æ€

- å¼€å§‹æ—¥æœŸ: 2026-01-06
- å®Œæˆæ—¥æœŸ: -
- å½“å‰çŠ¶æ€: ğŸ”¨ è¿›è¡Œä¸­

### å·²å®Œæˆå·¥ä½œ

1. âœ… Rust æµ‹è¯•å‘é‡ç”Ÿæˆå™¨ (`program-test/src/lib.rs`)
2. âœ… æµ‹è¯•å‘é‡ç”ŸæˆäºŒè¿›åˆ¶ (`program-test/src/bin/generate_vectors.rs`)
3. âœ… Zig é›†æˆæµ‹è¯•æ¡†æ¶ (`program-test/integration/`)
4. âœ… PublicKey Base58 ç¼–è§£ç æµ‹è¯•
5. âœ… Hash Base58 ç¼–è§£ç æµ‹è¯•
6. âœ… æ›´æ–° test.sh æ”¯æŒé›†æˆæµ‹è¯•
7. âœ… Signature Base58 ç¼–è§£ç æµ‹è¯• (SDK å·²æ·»åŠ  toBase58 æ–¹æ³•)
8. âœ… PDA æ´¾ç”Ÿæµ‹è¯• (SDK å·²æ·»åŠ  findProgramAddressSlice è¿è¡Œæ—¶ç‰ˆæœ¬)

### å¾…å®Œæˆå·¥ä½œ

1. bincode åºåˆ—åŒ–æµ‹è¯• (Rust ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜å¾…è§£å†³)
2. EpochInfo JSON å…¼å®¹æ€§æµ‹è¯•

## å‚è€ƒèµ„æ–™

- [solana-sdk GitHub](https://github.com/anza-xyz/solana-sdk)
- [bincode crate](https://docs.rs/bincode)
- [Solana RPC API](https://solana.com/docs/rpc)
